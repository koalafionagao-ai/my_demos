
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SafePay - Bank ABC</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              background: '#050505',
              surface: '#121214',
              surfaceHighlight: '#27272a',
              border: '#3f3f46',
              primary: '#FF4D00',
              primaryHover: '#cc3d00',
              textMain: '#ffffff',
              textMuted: '#a1a1aa',
            },
            animation: {
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
              'fade-in': 'fadeIn 0.5s ease-out',
              'fade-in-up': 'fadeInUp 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #050505;
        background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #050505 60%);
        color: #fafafa;
        min-height: 100vh;
        overflow: hidden; /* Prevent body scroll, handle in app */
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent; 
      }
      ::-webkit-scrollbar-thumb {
        background: #3f3f46; 
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #52525b; 
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background-color: transparent;
      }
    </style>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
      const { useState, useEffect, useRef, Fragment } = React;

      // ----------------------------------------------------------------------
      // CONSTANTS & DATA
      // ----------------------------------------------------------------------
      const ROLES = [
        {
          id: 'engineer',
          title: 'Security Engineer',
          name: 'Andy',
          icon: 'fa-user-shield',
          description: 'Monitor alerts, investigate anomalies, and manage daily security tasks.'
        },
        {
          id: 'security_manager',
          title: 'Security Manager',
          name: 'Cindy',
          icon: 'fa-user-secret',
          description: 'Oversee security status, analyze aggregated risks, and coordinate team response.'
        },
        {
          id: 'business_manager',
          title: 'Business Manager',
          name: 'Ben',
          icon: 'fa-briefcase',
          description: 'Assess financial impact, manage customer communications, and business risks.'
        },
        {
          id: 'executive',
          title: 'Executive Mgmt',
          name: 'Mng',
          icon: 'fa-building-columns',
          description: 'View high-level metrics, strategic health, and make critical decisions.'
        }
      ];

      const ROLE_DATA = {
        engineer: {
          menu: [
            { label: 'Monitoring', icon: 'fa-gauge-high', active: true },
            { label: 'Event Analysis', icon: 'fa-magnifying-glass' },
            { label: 'Investigations', icon: 'fa-file-contract' }, 
          ],
          messages: [
            { id: 1, from: 'System', text: 'ALERT: 5,000+ failed logins from subnet 45.22.x.x', time: 'Now', unread: true, direction: 'inbox' },
            { id: 2, from: 'Cindy', text: 'Did you see the spike in foreign credit card txns?', time: '5m ago', unread: true, direction: 'inbox' },
            { id: 3, from: 'System', text: 'Firewall blocked 200 malicious packets.', time: '12m ago', unread: false, direction: 'inbox' }
          ],
          todos: [
            { id: 1, text: 'Investigate Credential Stuffing on Auth API', done: false, assignedBy: 'System (Automated)', priority: 'critical' },
            { id: 2, text: 'Export logs for Incident #9921', done: false, assignedBy: 'Cindy (Manager)', priority: 'high' },
            { id: 3, text: 'Patch vulnerability CVE-2025-01', done: true, assignedBy: 'CISO Office', priority: 'medium' }
          ]
        },
        security_manager: {
          menu: [
            { label: 'Security Status', icon: 'fa-shield-heart', active: true },
            { label: 'Decision Hub', icon: 'fa-gavel' }, 
          ],
          messages: [
            { id: 1, from: 'Andy', text: 'Requesting approval to blackhole subnet 45.22.x.x', time: '2m ago', unread: true, direction: 'inbox' },
            { id: 2, from: 'Mng', text: 'What is our exposure on the loan fraud issue?', time: '1h ago', unread: true, direction: 'inbox' }
          ],
          todos: [
            { id: 1, text: 'Approve Subnet Block (Andy)', done: false, assignedBy: 'Request Queue', priority: 'high' },
            { id: 2, text: 'Review High-Value Fraud Alerts', done: false, assignedBy: 'System', priority: 'medium' },
            { id: 3, text: 'Weekly team sync', done: true, assignedBy: 'Calendar', priority: 'low' }
          ]
        },
        business_manager: {
          menu: [
            { label: 'Business Impact', icon: 'fa-chart-line', active: true },
            { label: 'Outreach', icon: 'fa-comments' },
          ],
          messages: [
            { id: 1, from: 'Risk System', text: 'Loan App #882 flagged: Forged Documents.', time: '30m ago', unread: true, direction: 'inbox' },
            { id: 2, from: 'Cindy', text: 'Heads up: We are freezing 50 accounts due to fraud.', time: '1h ago', unread: false, direction: 'inbox' }
          ],
          todos: [
            { id: 1, text: 'Review 12 Suspicious Loan Apps', done: false, assignedBy: 'Fraud Dept', priority: 'critical' },
            { id: 2, text: 'Draft communication for blocked CC users', done: false, assignedBy: 'Cindy', priority: 'high' },
            { id: 3, text: 'Update fraud insurance policy', done: true, assignedBy: 'Legal', priority: 'low' }
          ]
        },
        executive: {
          menu: [
            { label: 'Overview', icon: 'fa-layer-group', active: true },
            { label: 'Governance', icon: 'fa-scale-balanced' }, 
          ],
          messages: [
            { id: 1, from: 'Cindy', text: 'Active attack contained. Detailed report shortly.', time: '10m ago', unread: true, direction: 'inbox' },
            { id: 2, from: 'Board', text: 'Meeting scheduled: Q3 Security Review.', time: '1d ago', unread: false, direction: 'inbox' }
          ],
          todos: [
            { id: 1, text: 'Authorize AI Defense Budget', done: false, assignedBy: 'Board', priority: 'high' },
            { id: 2, text: 'Review Quarterly Risk Posture', done: false, assignedBy: 'Compliance', priority: 'medium' },
            { id: 3, text: 'Sign off on Compliance Audit', done: true, assignedBy: 'Auditors', priority: 'low' }
          ]
        }
      };

      // ----------------------------------------------------------------------
      // SHARED UI COMPONENTS
      // ----------------------------------------------------------------------
      
      const Icon = ({ name, className = "" }) => (
        <i className={`fa-solid ${name} ${className}`}></i>
      );

      const StatCard = ({ title, value, subtext, trend, trendUp, icon, color = "text-primary" }) => (
        <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-5 flex flex-col h-full hover:border-primary/50 transition-all duration-300 group shadow-lg">
          <div className="flex justify-between items-start mb-2 h-10">
            <h3 className="text-textMuted text-[10px] font-bold uppercase tracking-widest leading-relaxed max-w-[75%] line-clamp-2">{title}</h3>
            <div className={`p-2 rounded-lg bg-white/5 border border-white/5 group-hover:bg-opacity-80 transition-colors ${color} shrink-0 ml-2 w-8 h-8 flex items-center justify-center`}>
              <Icon name={icon} />
            </div>
          </div>
          <div className="flex-1"></div>
          <div>
            <div className="text-3xl font-bold text-white mb-2 tracking-tight leading-none truncate h-9 flex items-center" title={value}>{value}</div>
            <div className="flex items-center gap-2 text-xs font-medium h-5 overflow-hidden">
              {trend && (
                <span className={`px-1.5 py-0.5 rounded ${trendUp ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'} flex items-center gap-1 shrink-0`}>
                  <Icon name={trendUp ? 'fa-arrow-up' : 'fa-arrow-down'} className="text-[10px]" /> {trend}
                </span>
              )}
              <span className="text-textMuted/80 truncate">{subtext}</span>
            </div>
          </div>
        </div>
      );

      const SectionHeader = ({ title, action, tooltip, onAction }) => (
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-bold text-white flex items-center gap-2" title={tooltip}>
            <div className="w-1 h-5 bg-primary rounded-full shadow-[0_0_10px_rgba(249,115,22,0.5)]"></div>
            {title}
          </h2>
          {action && (
            <button onClick={onAction} className="text-xs text-primary hover:text-white transition-colors font-semibold tracking-wide flex items-center gap-1 group bg-white/5 px-3 py-1.5 rounded border border-white/10 hover:border-primary/50">
              <Icon name="fa-microchip" className="text-[10px]" /> {action}
            </button>
          )}
        </div>
      );

      const Modal = ({ isOpen, onClose, title, children, hideFooter = false }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
            <div className="bg-surface/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl w-full max-w-4xl z-10 animate-fade-in-up flex flex-col max-h-[90vh]">
              <div className="flex items-center justify-between p-6 border-b border-white/5">
                <h3 className="text-xl font-bold text-white tracking-tight flex items-center gap-3">
                  <div className="w-1 h-6 bg-primary rounded-full"></div>
                  {title}
                </h3>
                <button onClick={onClose} className="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-textMuted hover:text-white transition-colors">
                  <Icon name="fa-xmark" className="text-sm" />
                </button>
              </div>
              <div className="p-6 overflow-y-auto">
                {children}
              </div>
              {!hideFooter && (
                <div className="p-4 border-t border-white/5 bg-black/20 flex justify-end rounded-b-2xl">
                  <button onClick={onClose} className="px-5 py-2 bg-white text-black font-bold rounded-lg hover:bg-gray-200 text-sm shadow-lg shadow-white/5 transition-all">Close</button>
                </div>
              )}
            </div>
          </div>
        );
      };

      const Toast = ({ message, type = 'success', onClose }) => {
        useEffect(() => {
          const timer = setTimeout(onClose, 3000);
          return () => clearTimeout(timer);
        }, [onClose]);

        return (
          <div className="fixed bottom-8 right-8 z-50 animate-fade-in-up">
            <div className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-2xl border backdrop-blur-md ${
              type === 'success' ? 'bg-green-500/10 border-green-500/50 text-green-400' : 'bg-blue-500/10 border-blue-500/50 text-blue-400'
            }`}>
              <Icon name={type === 'success' ? 'fa-circle-check' : 'fa-info-circle'} />
              <span className="font-medium text-sm tracking-wide">{message}</span>
            </div>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // VISUALIZATIONS
      // ----------------------------------------------------------------------

      const DynamicThreatMap = () => {
        const [threats, setThreats] = useState([]);
        
        useEffect(() => {
          const initialThreats = [
              { id: 101, x: 23, y: 34, size: 14, type: 'viral', color: '#a855f7' }, 
              { id: 102, x: 15, y: 36, size: 8, type: 'unknown', color: '#f97316' }, 
              { id: 401, x: 32, y: 68, size: 10, type: 'unknown', color: '#f97316' },
              { id: 201, x: 51, y: 28, size: 12, type: 'viral', color: '#a855f7' },
              { id: 301, x: 74, y: 38, size: 25, type: 'unknown', color: '#ef4444' }, 
              { id: 302, x: 86, y: 36, size: 8, type: 'viral', color: '#a855f7' },
              { id: 501, x: 88, y: 78, size: 10, type: 'bacterial', color: '#3b82f6' },
              { id: 601, x: 53, y: 55, size: 8, type: 'unknown', color: '#f97316' },
          ];
          setThreats(initialThreats);

          const interval = setInterval(() => {
              setThreats(prev => {
                  return prev.map(t => ({
                      ...t,
                      size: Math.max(5, Math.min(30, t.size + (Math.random() - 0.5) * 2))
                  }));
              });
          }, 1000);
          return () => clearInterval(interval);
        }, []);

        // Simplified map for SVG embedding
        return (
          <div className="flex-1 bg-[#09090b] rounded-2xl border border-white/10 relative flex items-center justify-center overflow-hidden group h-[500px] shadow-2xl">
              <div className="absolute inset-0 z-0 opacity-10 pointer-events-none" 
                   style={{
                       backgroundImage: 'linear-gradient(#27272a 1px, transparent 1px), linear-gradient(90deg, #27272a 1px, transparent 1px)',
                       backgroundSize: '40px 40px'
                   }}>
              </div>
              <div className="absolute inset-0 z-0 flex items-center justify-center px-6 py-6 select-none opacity-100">
                 <svg viewBox="0 0 126 60" className="w-full h-full">
                    {/* Simplified Dotted Map representation for brevity */}
                    <g className="fill-[#4a4a4a] hover:fill-[#666666] transition-colors duration-500">
                      <circle cx="23" cy="34" r="2" />
                      <circle cx="15" cy="36" r="2" />
                      <circle cx="32" cy="68" r="2" />
                      <circle cx="51" cy="28" r="2" />
                      <circle cx="74" cy="38" r="2" />
                      <circle cx="86" cy="36" r="2" />
                      <circle cx="88" cy="78" r="2" />
                      <circle cx="53" cy="55" r="2" />
                      {/* Generating some random dots to simulate the world map */}
                      {[...Array(200)].map((_, i) => (
                         <circle key={i} cx={Math.random()*126} cy={Math.random()*60} r="0.22" />
                      ))}
                    </g>
                    <line x1="0" y1="0" x2="126" y2="0" stroke="rgba(255,255,255,0.05)" strokeWidth="0.5">
                       <animate attributeName="y1" from="0" to="60" dur="5s" repeatCount="indefinite" />
                       <animate attributeName="y2" from="0" to="60" dur="5s" repeatCount="indefinite" />
                       <animate attributeName="opacity" values="0;1;0" dur="5s" repeatCount="indefinite" />
                    </line>
                 </svg>
              </div>
              {threats.map(t => (
                <div 
                  key={t.id}
                  className="absolute z-10 flex items-center justify-center transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group pointer-events-none"
                  style={{ left: `${t.x}%`, top: `${t.y}%` }}
                >
                   <div 
                     className="absolute rounded-full opacity-20 animate-ping-slow"
                     style={{ 
                         width: `${t.size * 5}px`, 
                         height: `${t.size * 5}px`,
                         backgroundColor: t.color,
                         animationDuration: '3s'
                     }}
                   ></div>
                   <div 
                      className="absolute rounded-full opacity-60 blur-md"
                      style={{ 
                          width: `${t.size * 1.5}px`, 
                          height: `${t.size * 1.5}px`,
                          backgroundColor: t.color,
                      }}
                   ></div>
                   <div 
                      className="relative rounded-full border border-white/90 shadow-lg bg-white"
                      style={{ 
                          width: '5px', 
                          height: '5px',
                      }}
                   ></div>
                   <div className="absolute top-4 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-[#18181b] border border-white/20 px-2 py-1 rounded text-[10px] whitespace-nowrap z-20 pointer-events-none shadow-xl text-white">
                      Threat ID: {t.id}
                   </div>
                </div>
              ))}
              <div className="absolute bottom-5 left-6 flex items-center gap-3 z-20">
                   <div className="flex items-center gap-2 px-3 py-1 bg-[#18181b]/90 border border-white/10 rounded-full backdrop-blur-md shadow-lg">
                      <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
                      <span className="text-[10px] font-mono text-white font-bold tracking-widest uppercase">Live Feed</span>
                   </div>
              </div>
          </div>
        );
      };

      const RawTrafficViewer = () => {
          return (
              <div className="font-mono text-xs text-green-400 bg-black p-4 rounded-lg h-[60vh] overflow-hidden flex flex-col">
                  <div className="flex justify-between border-b border-green-500/20 pb-2 mb-2 text-green-600">
                      <span>TIMESTAMP</span>
                      <span>SRC_IP</span>
                      <span>DST_IP</span>
                      <span>PROTOCOL</span>
                      <span>FLAG</span>
                      <span>PAYLOAD_SIZE</span>
                  </div>
                  <div className="flex-1 overflow-hidden relative">
                      <div className="absolute inset-0 overflow-y-auto custom-scrollbar space-y-1">
                          {Array.from({length: 50}).map((_, i) => (
                              <div key={i} className={`flex justify-between opacity-${Math.max(20, 100 - i*2)} hover:bg-green-500/10 cursor-crosshair`}>
                                 <span>{new Date().toISOString().split('T')[1].split('.')[0]}.{Math.floor(Math.random()*999)}</span>
                                 <span>45.22.10.{Math.floor(Math.random()*255)}</span>
                                 <span>10.0.5.{Math.floor(Math.random()*20)}</span>
                                 <span>{Math.random() > 0.8 ? 'UDP' : 'TCP'}</span>
                                 <span className={Math.random() > 0.9 ? 'text-red-500 font-bold' : ''}>{Math.random() > 0.9 ? '[SYN,ACK]' : '[ACK]'}</span>
                                 <span>{Math.floor(Math.random()*1500)}b</span>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          )
      }

      // ----------------------------------------------------------------------
      // FORMS
      // ----------------------------------------------------------------------

      const NewTaskForm = ({ onClose, onSuccess }) => {
        const handleSubmit = (e) => {
          e.preventDefault();
          onSuccess();
          onClose();
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg text-xs text-blue-300 mb-4 flex gap-2">
               <Icon name="fa-info-circle" className="mt-0.5" />
               <span>This will create a formal system ticket visible to the entire team.</span>
            </div>
            <div>
              <label className="block text-xs uppercase tracking-wider text-textMuted mb-2">Task Title</label>
              <input type="text" required placeholder="e.g., Investigate Subnet 192.x" className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition-colors" />
            </div>
            <div className="grid grid-cols-2 gap-4">
               <div>
                  <label className="block text-xs uppercase tracking-wider text-textMuted mb-2">Priority</label>
                  <select className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-primary focus:outline-none">
                    <option>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                    <option>Critical</option>
                  </select>
               </div>
               <div>
                  <label className="block text-xs uppercase tracking-wider text-textMuted mb-2">Assignee</label>
                  <select className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-primary focus:outline-none">
                    <option>Andy (Engineer)</option>
                    <option>Cindy (Manager)</option>
                    <option>Ben (Business)</option>
                  </select>
               </div>
            </div>
            <div>
              <label className="block text-xs uppercase tracking-wider text-textMuted mb-2">Description</label>
              <textarea rows={3} className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-primary focus:outline-none" placeholder="Add details..."></textarea>
            </div>
            <div className="pt-2">
               <button type="submit" className="w-full bg-primary hover:bg-primaryHover text-black font-bold py-3 rounded-lg shadow-[0_0_15px_rgba(249,115,22,0.4)] transition-all">Create Ticket</button>
            </div>
          </form>
        );
      };

      const SettingsPanel = ({ onClose, onSuccess }) => {
        return (
          <div className="space-y-6">
             <div className="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5">
                <div className="flex items-center gap-4">
                   <div className="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                      <Icon name="fa-bell" />
                   </div>
                   <div>
                      <div className="font-bold text-white">System Notifications</div>
                      <div className="text-xs text-textMuted">Receive real-time alerts via toast</div>
                   </div>
                </div>
                <div className="w-10 h-5 bg-primary/20 rounded-full relative cursor-pointer">
                   <div className="absolute right-0.5 top-0.5 w-4 h-4 bg-primary rounded-full shadow-sm"></div>
                </div>
             </div>

             <div className="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5">
                <div className="flex items-center gap-4">
                   <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">
                      <Icon name="fa-eye" />
                   </div>
                   <div>
                      <div className="font-bold text-white">Data Refresh Rate</div>
                      <div className="text-xs text-textMuted">Current: Real-time (WebSocket)</div>
                   </div>
                </div>
                 <div className="w-10 h-5 bg-primary/20 rounded-full relative cursor-pointer">
                   <div className="absolute right-0.5 top-0.5 w-4 h-4 bg-primary rounded-full shadow-sm"></div>
                </div>
             </div>
             
             <div className="p-4 bg-black/30 rounded-xl border border-white/5 text-center">
                <div className="text-xs text-textMuted uppercase tracking-widest mb-1">System Version</div>
                <div className="font-mono text-sm text-white">SafePay v3.0.4-beta (Build 8821)</div>
             </div>

             <button onClick={() => { onSuccess(); onClose(); }} className="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-lg border border-white/10 transition-all">
                Save Configuration
             </button>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // LAYOUT / SIDEBAR
      // ----------------------------------------------------------------------

      const LeftSidebar = ({ currentRole, activeView, onChangeRole, onSettingsClick, onNavigate }) => {
        const roleInfo = ROLES.find(r => r.id === currentRole);
        const menuItems = currentRole && ROLE_DATA[currentRole] ? ROLE_DATA[currentRole].menu : [];

        const handleMenuClick = (label) => {
            if (!onNavigate) return;
            const viewMapping = {
                // Engineer
                'Monitoring': 'monitoring',
                'Event Analysis': 'event_analysis',
                'Investigations': 'investigations',
                
                // Manager
                'Security Status': 'security_status',
                'Decision Hub': 'decision_hub',
                
                // Business
                'Business Impact': 'business_impact',
                'Outreach': 'outreach',
                
                // Executive
                'Overview': 'overview',
                'Governance': 'governance'
            };
            const targetView = viewMapping[label];
            if (targetView) {
                onNavigate(targetView);
            } else {
                onNavigate('monitoring'); 
            }
        };

        const isActive = (label) => {
            if (!activeView) return false;
            if (label === 'Monitoring' && activeView === 'monitoring') return true;
            if (label === 'Event Analysis' && activeView === 'event_analysis') return true;
            if (label === 'Investigations' && activeView === 'investigations') return true;
            if (label === 'Security Status' && activeView === 'security_status') return true;
            if (label === 'Decision Hub' && activeView === 'decision_hub') return true;
            if (label === 'Business Impact' && activeView === 'business_impact') return true;
            if (label === 'Outreach' && activeView === 'outreach') return true;
            if (label === 'Overview' && activeView === 'overview') return true;
            if (label === 'Governance' && activeView === 'governance') return true;
            return false;
        };

        return (
          <div className="w-72 bg-surface/80 backdrop-blur-2xl border-r border-white/5 flex flex-col h-full shrink-0 z-20 shadow-[5px_0_30px_rgba(0,0,0,0.5)]">
            <div className="p-8">
              <div className="flex items-center gap-3 font-bold text-2xl tracking-tight text-white">
                <div className="w-10 h-10 bg-gradient-to-br from-primary to-orange-600 rounded-lg flex items-center justify-center text-black shadow-[0_0_15px_rgba(249,115,22,0.4)]">
                  <Icon name="fa-shield-halved" className="text-lg" />
                </div>
                <span>SafePay</span>
              </div>
              <div className="mt-3 text-[10px] text-textMuted uppercase tracking-[0.2em] opacity-70">Bank ABC Security</div>
            </div>

            <nav className="flex-1 px-6 space-y-2">
              <div className="text-[10px] font-bold text-textMuted mb-4 px-2 uppercase tracking-widest opacity-50">Main Menu</div>
              {menuItems.map((item, idx) => {
                const active = isActive(item.label);
                return (
                  <button
                      key={idx}
                      onClick={() => handleMenuClick(item.label)}
                      className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium transition-all duration-200 group ${
                      active 
                          ? 'bg-primary/10 text-white border border-primary/20 shadow-[0_0_15px_rgba(249,115,22,0.1)]' 
                          : 'text-textMuted hover:text-white hover:bg-white/5 border border-transparent'
                      }`}
                  >
                      <Icon name={item.icon} className={`w-5 text-center transition-colors ${active ? 'text-primary' : 'group-hover:text-white'}`} />
                      {item.label}
                  </button>
                );
              })}
              
              <div className="mt-8 text-[10px] font-bold text-textMuted mb-4 px-2 uppercase tracking-widest opacity-50">System</div>
              <button onClick={onSettingsClick} className="w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium text-textMuted hover:text-white hover:bg-white/5 transition-all group">
                  <Icon name="fa-gear" className="w-5 text-center group-hover:rotate-45 transition-transform duration-300" /> Settings
              </button>
            </nav>

            <div className="p-6 border-t border-white/5">
              <button 
                onClick={onChangeRole}
                className="w-full flex items-center gap-3 p-3 rounded-xl bg-black/20 hover:bg-white/5 border border-white/5 hover:border-white/10 transition-all text-left group"
              >
                <div className="w-10 h-10 rounded-lg bg-primary/10 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-black transition-colors">
                   <Icon name={roleInfo?.icon || 'fa-user'} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-sm font-bold text-white truncate">{roleInfo?.title}</div>
                  <div className="text-xs text-textMuted truncate font-mono mt-0.5">{roleInfo?.name}</div>
                </div>
                <Icon name="fa-right-from-bracket" className="text-textMuted hover:text-white text-xs" />
              </button>
            </div>
          </div>
        );
      };

      const RightSidebar = ({ currentRole, messages = [], todos = [], onToggleTodo }) => {
        const [activeTab, setActiveTab] = useState('inbox');
        
        const sortedTodos = [...todos].sort((a, b) => {
          const priorityVal = { critical: 3, high: 2, medium: 1, low: 0 };
          const pA = a.priority ? priorityVal[a.priority] : 0;
          const pB = b.priority ? priorityVal[b.priority] : 0;
          return pB - pA;
        });

        const filteredMessages = messages.filter((m) => m.direction === activeTab || (!m.direction && activeTab === 'inbox'));
        const unreadCount = messages.filter((m) => m.unread && m.direction === 'inbox').length;

        const getPriorityColor = (p) => {
          switch(p) {
            case 'critical': return 'text-red-500 border-red-500/30 bg-red-500/10 shadow-[0_0_8px_rgba(239,68,68,0.2)]';
            case 'high': return 'text-orange-500 border-orange-500/30 bg-orange-500/10';
            case 'medium': return 'text-blue-400 border-blue-500/30 bg-blue-500/10';
            default: return 'text-textMuted border-white/10 bg-white/5';
          }
        };

        return (
          <div className="w-80 bg-surface/80 backdrop-blur-2xl border-l border-white/5 flex flex-col h-full shrink-0 z-20 shadow-[-5px_0_30px_rgba(0,0,0,0.5)]">
            <div className="flex-1 flex flex-col overflow-hidden">
              <div className="p-6 border-b border-white/5 h-1/2 flex flex-col">
                <div className="flex items-center justify-between mb-4">
                   <h3 className="font-bold text-xs text-textMuted uppercase tracking-widest flex items-center gap-2">
                      <Icon name="fa-message" /> Comms Hub
                   </h3>
                   {unreadCount > 0 && activeTab === 'inbox' && (
                      <span className="text-[10px] bg-blue-500/20 text-blue-400 border border-blue-500/20 px-2 py-0.5 rounded-full font-bold animate-pulse">
                        {unreadCount} NEW
                      </span>
                   )}
                </div>
                
                <div className="flex bg-black/20 p-1 rounded-lg mb-4">
                   <button onClick={() => setActiveTab('inbox')} className={`flex-1 text-[10px] font-bold py-1.5 rounded transition-all ${activeTab === 'inbox' ? 'bg-white/10 text-white shadow-sm' : 'text-textMuted hover:text-white'}`}>Inbox</button>
                   <button onClick={() => setActiveTab('sent')} className={`flex-1 text-[10px] font-bold py-1.5 rounded transition-all ${activeTab === 'sent' ? 'bg-white/10 text-white shadow-sm' : 'text-textMuted hover:text-white'}`}>Sent</button>
                </div>

                <div className="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                  {filteredMessages.length === 0 ? (
                      <div className="text-center text-textMuted text-xs py-8 opacity-50 italic">No messages</div>
                  ) : (
                      filteredMessages.map((msg) => (
                      <div 
                          key={msg.id} 
                          className={`p-3 rounded-xl border transition-all group relative ${
                          msg.unread && activeTab === 'inbox'
                              ? 'bg-white/10 border-white/20 hover:bg-white/15' 
                              : 'bg-transparent border-transparent hover:bg-white/5 opacity-80 hover:opacity-100'
                          }`}
                      >
                          {msg.unread && activeTab === 'inbox' && (
                          <div className="absolute top-3 right-3 w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_8px_#3b82f6]"></div>
                          )}
                          
                          <div className="flex justify-between items-center mb-1">
                          <span className={`text-xs font-bold transition-colors ${msg.unread && activeTab === 'inbox' ? 'text-white' : 'text-textMuted group-hover:text-white'}`}>
                              {activeTab === 'sent' ? `To: ${msg.to || 'Team'}` : msg.from}
                          </span>
                          <span className="text-[9px] text-textMuted/60">{msg.time}</span>
                          </div>
                          <p className={`text-[11px] leading-relaxed line-clamp-3 ${msg.unread && activeTab === 'inbox' ? 'text-gray-200' : 'text-textMuted'}`}>{msg.text}</p>
                      </div>
                      ))
                  )}
                </div>
              </div>

              <div className="p-6 h-1/2 flex flex-col">
                <div className="flex items-center justify-between mb-6">
                   <h3 className="font-bold text-xs text-textMuted uppercase tracking-widest flex items-center gap-2">
                      <Icon name="fa-list-check" /> Tasks
                   </h3>
                </div>
                <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                  {sortedTodos.map((todo) => (
                    <div 
                      key={todo.id} 
                      onClick={() => onToggleTodo && onToggleTodo(todo.id)}
                      className="flex items-start gap-4 group hover:bg-white/5 p-2 rounded-lg transition-colors -mx-2 cursor-pointer relative"
                    >
                      <div className={`mt-0.5 w-5 h-5 rounded border flex items-center justify-center transition-all shrink-0 ${todo.done ? 'bg-primary border-primary' : 'border-white/20 group-hover:border-primary'}`}>
                        {todo.done && <Icon name="fa-check" className="text-black text-[10px]" />}
                      </div>
                      <div className="flex-1 min-w-0">
                         <div className="flex items-center justify-between mb-1">
                            <div className="flex gap-2 items-center">
                              {todo.priority && (
                                <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wider ${getPriorityColor(todo.priority)}`}>
                                   {todo.priority}
                                </span>
                              )}
                              {todo.assignedBy && (
                                <span className="text-[9px] font-bold text-textMuted uppercase tracking-wider opacity-60">
                                   {todo.assignedBy.split(' ')[0]}
                                </span>
                              )}
                            </div>
                         </div>
                         <span className={`text-sm transition-colors leading-snug select-none block ${todo.done ? 'text-textMuted/50 line-through decoration-white/20' : 'text-white group-hover:text-white'}`}>
                          {todo.text}
                         </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // DASHBOARDS
      // ----------------------------------------------------------------------

      // --- ENGINEER DASHBOARD COMPONENTS ---
      const getStatusColor = (status) => {
          switch(status) {
              case 'Open': return 'text-white border-transparent';
              case 'Active': return 'text-white border-transparent';
              case 'In Progress': return 'text-yellow-400 bg-yellow-400/10 border-yellow-400/20';
              case 'Mitigated': return 'text-green-400 bg-green-500/10 border-green-500/20 line-through decoration-white/20';
              case 'Pending Review': return 'text-blue-400 bg-blue-500/10 border-blue-500/20 italic';
              case 'Resolved': return 'text-textMuted opacity-50';
              default: return 'text-white';
          }
      };

      const AttackGraph = ({ type }) => {
          return (
              <div className="w-full h-48 bg-[#0c0c0c] rounded-lg border border-white/10 relative overflow-hidden flex items-center justify-center">
                  <div className="absolute top-2 left-3 text-[10px] text-textMuted uppercase tracking-widest font-bold">
                      <Icon name="fa-circle-nodes" className="mr-2" /> Attack Correlation Graph
                  </div>
                  
                  <svg viewBox="0 0 400 150" className="w-full h-full">
                      <defs>
                          <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                              <path d="M0,0 L0,6 L9,3 z" fill="#3f3f46" />
                          </marker>
                      </defs>

                      {type === 'stuffing' && (
                          <g>
                              <circle cx="50" cy="75" r="20" fill="#ef4444" opacity="0.2" className="animate-pulse" />
                              <circle cx="50" cy="75" r="8" fill="#ef4444" />
                              <text x="50" y="110" textAnchor="middle" fill="#ef4444" fontSize="10" fontWeight="bold">Attacker IP</text>
                              <text x="50" y="122" textAnchor="middle" fill="#71717a" fontSize="8" fontFamily="monospace">45.22.10.5</text>

                              <path d="M70,75 L300,30" stroke="#3f3f46" strokeWidth="1" strokeDasharray="4" markerEnd="url(#arrow)" />
                              <path d="M70,75 L300,75" stroke="#3f3f46" strokeWidth="1" strokeDasharray="4" markerEnd="url(#arrow)" />
                              <path d="M70,75 L300,120" stroke="#3f3f46" strokeWidth="1" strokeDasharray="4" markerEnd="url(#arrow)" />

                              <circle cx="320" cy="30" r="6" fill="#3b82f6" />
                              <text x="340" y="34" fill="#9ca3af" fontSize="10">Acc: #9921</text>
                              
                              <circle cx="320" cy="75" r="6" fill="#3b82f6" />
                              <text x="340" y="79" fill="#9ca3af" fontSize="10">Acc: #8812</text>
                              
                              <circle cx="320" cy="120" r="6" fill="#3b82f6" />
                              <text x="340" y="124" fill="#9ca3af" fontSize="10">Acc: #1102</text>

                              <text x="200" y="65" textAnchor="middle" fill="#ef4444" fontSize="10" fontWeight="bold">5,000+ Attempts</text>
                          </g>
                      )}

                      {type === 'velocity' && (
                          <g>
                              <circle cx="200" cy="75" r="25" fill="#f97316" opacity="0.2" />
                              <circle cx="200" cy="75" r="10" fill="#f97316" />
                              <text x="200" y="115" textAnchor="middle" fill="#f97316" fontSize="10" fontWeight="bold">Device Fingerprint</text>
                              <text x="200" y="127" textAnchor="middle" fill="#71717a" fontSize="8" fontFamily="monospace">iPhone 14 (Jailbroken)</text>

                              <line x1="180" y1="75" x2="80" y2="40" stroke="#3f3f46" strokeWidth="1" />
                              <line x1="180" y1="75" x2="80" y2="110" stroke="#3f3f46" strokeWidth="1" />
                              <line x1="220" y1="75" x2="320" y2="40" stroke="#3f3f46" strokeWidth="1" />
                              <line x1="220" y1="75" x2="320" y2="110" stroke="#3f3f46" strokeWidth="1" />

                              <circle cx="80" cy="40" r="5" fill="#a1a1aa" />
                              <circle cx="80" cy="110" r="5" fill="#a1a1aa" />
                              <circle cx="320" cy="40" r="5" fill="#a1a1aa" />
                              <circle cx="320" cy="110" r="5" fill="#a1a1aa" />
                              
                              <text x="200" y="45" textAnchor="middle" fill="#f97316" fontSize="9">15 Accounts / 1 Min</text>
                          </g>
                      )}

                      {type === 'synthetic' && (
                          <g>
                              <rect x="150" y="50" width="100" height="50" rx="5" fill="#2e1065" stroke="#a855f7" strokeWidth="2" />
                              <text x="200" y="75" textAnchor="middle" fill="#d8b4fe" fontSize="12" fontWeight="bold">Synthetic ID</text>
                              <text x="200" y="90" textAnchor="middle" fill="#a855f7" fontSize="8">Pattern #8821</text>

                              <line x1="150" y1="75" x2="80" y2="75" stroke="#a855f7" strokeWidth="1" strokeDasharray="2" />
                              <circle cx="80" cy="75" r="15" fill="#18181b" stroke="#3f3f46" />
                              <text x="80" y="79" textAnchor="middle" fill="white" fontSize="8">SSN</text>
                              <text x="80" y="105" textAnchor="middle" fill="#ef4444" fontSize="8">Deceased '98</text>

                              <line x1="250" y1="75" x2="320" y2="75" stroke="#a855f7" strokeWidth="1" strokeDasharray="2" />
                              <circle cx="320" cy="75" r="15" fill="#18181b" stroke="#3f3f46" />
                              <text x="320" y="79" textAnchor="middle" fill="white" fontSize="8">Phone</text>
                              <text x="320" y="105" textAnchor="middle" fill="#f97316" fontSize="8">VoIP Range</text>
                          </g>
                      )}
                  </svg>
              </div>
          );
      };

      const DecisionPanel = ({ incident, value, onChange }) => {
          const renderSecondaryActions = () => {
              if (!value.type) return null;

              let actions = [];
              let description = "";

              switch(value.type) {
                  case 'pass':
                      description = "Mark as safe. System will learn from this pattern.";
                      actions = [
                          { label: 'Confirm False Positive', icon: 'fa-check', action: 'false_positive' },
                          { label: 'Whitelist User', icon: 'fa-user-check', action: 'whitelist' }
                      ];
                      break;
                  case 'challenge':
                      description = "Trigger step-up authentication for next action.";
                      actions = [
                          { label: 'Trigger SMS 2FA', icon: 'fa-comment-sms', action: 'sms_2fa' },
                          { label: 'Require Bio-Auth', icon: 'fa-fingerprint', action: 'bio_auth' },
                          { label: 'Video Call Verification', icon: 'fa-video', action: 'video_verify' }
                      ];
                      break;
                  case 'block':
                      description = "Immediate mitigation required. High confidence threat.";
                      actions = [
                          { label: 'Request IP Isolation (Escalate)', icon: 'fa-shield-virus', action: 'isolate_ip' },
                          { label: 'Suspend Cards & Freeze', icon: 'fa-ban', action: 'suspend_cards' },
                          { label: 'Blacklist Device ID', icon: 'fa-mobile-screen', action: 'blacklist_device' }
                      ];
                      break;
                  case 'review':
                      description = "Complex scenario requiring deeper investigation.";
                      actions = [
                          { label: 'Deep Verify Background', icon: 'fa-magnifying-glass-plus', action: 'deep_verify' },
                          { label: 'Create Investigation Ticket', icon: 'fa-file-pen', action: 'create_ticket' }
                      ];
                      break;
              }

              return (
                  <div className="mt-4 p-4 bg-white/5 rounded-lg border border-white/10 animate-fade-in">
                      <div className="text-xs text-textMuted mb-3 flex items-center gap-2">
                          <Icon name="fa-arrow-turn-down" className="text-primary" />
                          {description}
                      </div>
                      <div className="flex flex-wrap gap-3">
                          {actions.map((act, idx) => (
                              <button 
                                  key={idx}
                                  onClick={() => onChange({ ...value, secondary: act.action })}
                                  className={`px-4 py-2 rounded-lg border text-xs font-bold flex items-center gap-2 transition-all 
                                      ${value.secondary === act.action 
                                          ? value.type === 'pass' ? 'bg-green-500 text-black border-green-500' :
                                            value.type === 'challenge' ? 'bg-yellow-500 text-black border-yellow-500' :
                                            value.type === 'block' ? 'bg-red-500 text-white border-red-500' :
                                            'bg-blue-600 text-white border-blue-600'
                                          : 'bg-black/40 border-white/20 hover:bg-white/10 text-textMuted hover:text-white'
                                      }`}
                              >
                                  <Icon name={act.icon} /> {act.label}
                              </button>
                          ))}
                      </div>
                  </div>
              );
          };

          return (
              <div className="mt-6 border-t border-white/10 pt-6">
                  <div className="text-xs font-bold text-textMuted uppercase tracking-widest mb-4">Decision Engine</div>
                  <div className="grid grid-cols-4 gap-4">
                      <button 
                          onClick={() => onChange({ type: 'pass', secondary: null })}
                          className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all group ${value.type === 'pass' ? 'bg-green-500 text-black border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.4)]' : 'bg-black/40 border-white/10 hover:border-green-500/50 hover:text-green-400'}`}
                      >
                          <Icon name="fa-circle-check" className="text-lg" />
                          <span className="text-xs font-bold">PASS</span>
                      </button>
                      <button 
                          onClick={() => onChange({ type: 'challenge', secondary: null })}
                          className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all group ${value.type === 'challenge' ? 'bg-yellow-500 text-black border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.4)]' : 'bg-black/40 border-white/10 hover:border-yellow-500/50 hover:text-yellow-400'}`}
                      >
                          <Icon name="fa-shield-halved" className="text-lg" />
                          <span className="text-xs font-bold">CHALLENGE</span>
                      </button>
                      <button 
                          onClick={() => onChange({ type: 'block', secondary: null })}
                          className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all group ${value.type === 'block' ? 'bg-red-500 text-white border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.4)]' : 'bg-black/40 border-white/10 hover:border-red-500/50 hover:text-red-400'}`}
                      >
                          <Icon name="fa-ban" className="text-lg" />
                          <span className="text-xs font-bold">BLOCK</span>
                      </button>
                      <button 
                          onClick={() => onChange({ type: 'review', secondary: null })}
                          className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all group ${value.type === 'review' ? 'bg-blue-600 text-white border-blue-600 shadow-[0_0_15px_rgba(37,99,235,0.4)]' : 'bg-black/40 border-white/10 hover:border-blue-500/50 hover:text-blue-400'}`}
                      >
                          <Icon name="fa-magnifying-glass" className="text-lg" />
                          <span className="text-xs font-bold">REVIEW</span>
                      </button>
                  </div>
                  {renderSecondaryActions()}
              </div>
          );
      };

      const IncidentHistoryPanel = ({ history }) => {
          return (
              <div className="h-full bg-black/20 border-l border-white/10 p-4 flex flex-col">
                  <div className="text-xs font-bold text-textMuted uppercase tracking-widest mb-4 flex items-center gap-2">
                      <Icon name="fa-clock-rotate-left" /> Processing History
                  </div>
                  <div className="flex-1 overflow-y-auto custom-scrollbar relative pl-2">
                      <div className="absolute left-[11px] top-2 bottom-0 w-px bg-white/10"></div>
                      {history.length === 0 && <div className="text-xs text-textMuted italic ml-6">No activity recorded.</div>}
                      {history.slice().reverse().map((entry, idx) => (
                          <div key={idx} className="relative mb-6 ml-6 animate-fade-in-up" style={{animationDelay: `${idx * 0.1}s`}}>
                              <div className={`absolute -left-[19px] top-1.5 w-2.5 h-2.5 rounded-full border border-black ${
                                  entry.action.includes('Block') ? 'bg-red-500' :
                                  entry.action.includes('Flagged') ? 'bg-yellow-500' :
                                  'bg-primary'
                              }`}></div>
                              <div className="flex justify-between items-start">
                                  <span className="text-xs font-bold text-white">{entry.action}</span>
                                  <span className="text-[10px] text-textMuted font-mono">{entry.time}</span>
                              </div>
                              <div className="text-[11px] text-textMuted mt-1">by <span className="text-white">{entry.actor}</span></div>
                              <div className="text-[10px] text-textMuted/60 mt-1 italic leading-tight">
                                  {entry.detail}
                              </div>
                          </div>
                      ))}
                  </div>
              </div>
          );
      };

      const IncidentModalContent = ({ item, decisionValue, onDecisionChange }) => {
          let graphType = 'stuffing';
          if (item.title.includes('Velocity') || item.title.includes('Travel')) graphType = 'velocity';
          if (item.title.includes('Loan') || item.title.includes('Identity')) graphType = 'synthetic';

          return (
              <div className="space-y-6">
                  <AttackGraph type={graphType} />
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="p-3 bg-black/40 rounded border border-white/10">
                          <div className="text-[10px] text-textMuted uppercase tracking-widest mb-2 flex items-center gap-2"><Icon name="fa-network-wired" /> Contextual (Tech)</div>
                          <div className="text-xs space-y-1">
                              <div className="flex justify-between"><span className="text-gray-400">IP Rep:</span> <span className={item.type === 'critical' ? "text-red-400 font-bold" : "text-white"}>{item.type === 'critical' ? 'Botnet (C2)' : 'Residential'}</span></div>
                              <div className="flex justify-between"><span className="text-gray-400">Location:</span> <span className="text-white">Volgograd, RU</span></div>
                          </div>
                      </div>
                      <div className="p-3 bg-black/40 rounded border border-white/10">
                          <div className="text-[10px] text-textMuted uppercase tracking-widest mb-2 flex items-center gap-2"><Icon name="fa-stopwatch" /> Behavioral (Pattern)</div>
                          <div className="text-xs space-y-1">
                              <div className="flex justify-between"><span className="text-gray-400">Velocity:</span> <span className="text-red-400 font-bold">High</span></div>
                              <div className="flex justify-between"><span className="text-gray-400">Targeting:</span> <span className="text-white">Multiple Accounts</span></div>
                          </div>
                      </div>
                      <div className="p-3 bg-black/40 rounded border border-white/10">
                          <div className="text-[10px] text-textMuted uppercase tracking-widest mb-2 flex items-center gap-2"><Icon name="fa-database" /> Entity (Data)</div>
                          <div className="text-xs space-y-1">
                              <div className="flex justify-between"><span className="text-gray-400">Score:</span> <span className="text-orange-400">85/100</span></div>
                              <div className="flex justify-between"><span className="text-gray-400">History:</span> <span className="text-white">New Device</span></div>
                          </div>
                      </div>
                  </div>
                  <div className="p-4 bg-white/5 border border-white/10 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                          <span className="text-sm font-bold text-white flex items-center gap-2"><Icon name="fa-robot" /> Strategy Execution</span>
                          <span className="text-xs bg-white/10 text-white px-2 py-0.5 rounded font-mono">Risk Score: 85</span>
                      </div>
                      <p className="text-xs text-textMuted leading-relaxed">
                          <strong className="text-white">Reason:</strong> Automated rule <span className="text-gray-300 font-mono">R_VEL_09</span> triggered due to high velocity login attempts from single IP.
                      </p>
                  </div>
                  <DecisionPanel incident={item} value={decisionValue} onChange={onDecisionChange} />
              </div>
          );
      };

      const IncidentActionWrapper = ({ item, onClose, onSubmitAction, onNotify }) => {
          const [decision, setDecision] = useState({ type: null, secondary: null });
          const [note, setNote] = useState('');

          const handleSubmit = () => {
              if (!decision.type) return;
              if (!decision.secondary) {
                  onNotify("Action Required: Please select a specific reason/method from the options below.");
                  return;
              }
              onSubmitAction(decision.type, decision.secondary, note);
          };

          return (
              <div className="flex flex-col h-full">
                  <div className="grid grid-cols-1 lg:grid-cols-3 h-full min-h-[500px]">
                      <div className="lg:col-span-2 pr-6">
                          <IncidentModalContent item={item} decisionValue={decision} onDecisionChange={setDecision} />
                          <div className="mt-4">
                              <textarea 
                                  value={note}
                                  onChange={(e) => setNote(e.target.value)}
                                  placeholder="Optional: Add context or notes for the next assignee..."
                                  className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-xs text-white focus:border-primary/50 focus:outline-none transition-colors resize-none h-20"
                              />
                          </div>
                      </div>
                      <div className="lg:col-span-1 h-full">
                          <IncidentHistoryPanel history={item.history || []} />
                      </div>
                  </div>
                  <div className="mt-6 pt-4 border-t border-white/5 flex justify-between items-center bg-black/20 -mx-6 -mb-6 px-6 py-4 rounded-b-2xl z-10 relative">
                      <div className="text-xs text-textMuted italic">
                          {decision.type ? `Action: ${decision.type.toUpperCase()}${decision.secondary ? ` / ${decision.secondary}` : ''}` : 'Select a decision action...'}
                      </div>
                      <div className="flex gap-3">
                          <button 
                              onClick={onClose} 
                              className="px-5 py-2.5 bg-transparent border border-white/10 text-textMuted hover:text-white rounded-lg text-sm font-bold transition-all"
                          >
                              Close
                          </button>
                          <button 
                              onClick={handleSubmit} 
                              className={`px-6 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-lg
                                  ${decision.type 
                                      ? 'bg-primary text-black hover:bg-primaryHover shadow-primary/20' 
                                      : 'bg-white/5 text-white/20 cursor-not-allowed'
                                  }`}
                          >
                              <Icon name="fa-paper-plane" /> Submit Decision
                          </button>
                      </div>
                  </div>
              </div>
          );
      };

      const EventAnalysisView = ({ incidents, highlightedId, onShowModal, onUpdateIncident, onEscalate, onNotify, onAddTask, onAddSentMessage, onSendMessageToRole, onBack, onNavigate }) => {
          const itemRefs = useRef({});

          useEffect(() => {
              if (highlightedId && itemRefs.current[highlightedId]) {
                  itemRefs.current[highlightedId]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
          }, [highlightedId]);

          const handleClaim = (id) => {
              onUpdateIncident(id, { 
                  status: 'In Progress', 
                  assignee: 'Andy',
                  history: [...(incidents.find(i => i.id === id)?.history || []), { 
                      actor: 'Andy', 
                      action: 'Claimed', 
                      time: 'Just now', 
                      detail: 'Owner assigned' 
                  }]
              });
              onNotify('Incident Claimed. Status updated to In Progress.');
          };

          const handleViewDetails = (item) => {
              const handleSubmitAction = (type, secondary, note) => {
                  onShowModal(null);
                  let detailText = secondary ? secondary.replace('_', ' ') : 'Manual decision';
                  if (note && note.trim() !== '') {
                      detailText += ` | Note: ${note}`;
                  }
                  const newHistoryEntry = {
                      actor: 'Andy',
                      action: type === 'pass' ? 'Marked Safe' : type === 'challenge' ? 'Challenged' : type === 'block' ? 'Blocked' : 'Reviewed',
                      time: 'Just now',
                      detail: detailText
                  };
                  const updatedHistory = [...(item.history || []), newHistoryEntry];
                  let updates = { history: updatedHistory };

                  if (!item.assignee) {
                      updates.assignee = 'Andy';
                  }

                  if (type === 'pass') {
                      updates.status = 'Mitigated';
                      updates.type = 'success';
                      updates.lastUpdated = 'Just now';
                      onNotify(`Incident #${item.id} Marked as Safe (False Positive).`);
                  } 
                  else if (type === 'challenge') {
                      updates.status = 'Pending Review';
                      updates.lastUpdated = 'Just now';
                      onNotify(`Challenge Triggered: ${secondary?.replace('_', ' ').toUpperCase()}`);
                      onAddSentMessage({ to: 'System', text: `Triggered ${secondary} for Incident #${item.id}` });
                  }
                  else if (type === 'block') {
                      if (secondary === 'isolate_ip') {
                          onEscalate({
                              id: Date.now(),
                              title: `Block Subnet ${item.ip}`,
                              requester: 'Andy (Eng)',
                              desc: `Manual Block Triggered via Dashboard`,
                              type: 'ban',
                              icon: 'fa-ban',
                              color: 'red'
                          });
                          updates.status = 'Pending Review';
                          updates.lastUpdated = 'Just now';
                      } else if (secondary === 'suspend_cards') {
                          updates.status = 'Mitigated';
                          updates.type = 'success';
                          updates.lastUpdated = 'Just now';
                          onNotify('Cards suspended successfully.');
                      } else {
                          updates.status = 'Mitigated';
                          updates.lastUpdated = 'Just now';
                          onNotify(`Block Action Executed: ${secondary}`);
                      }
                  }
                  else if (type === 'review') {
                      if (secondary === 'deep_verify') {
                          onNotify('Deep verification started...');
                          setTimeout(() => {
                              onNotify('Deep verification completed. Correlation found.');
                              onNavigate('investigations');
                          }, 1500);
                      } else {
                          onAddTask({ text: `Investigate Incident #${item.id}`, priority: 'medium', assignedBy: 'Self' });
                          onNotify('Investigation ticket created.');
                          updates.status = 'In Progress';
                          updates.lastUpdated = 'Just now';
                      }
                  }
                  onUpdateIncident(item.id, updates);
              };

              onShowModal({
                  title: `Incident Analysis: ${item.title}`,
                  hideFooter: true,
                  body: (
                      <IncidentActionWrapper 
                          item={item} 
                          onClose={() => onShowModal(null)} 
                          onSubmitAction={handleSubmitAction}
                          onNotify={onNotify}
                      />
                  )
              });
          };

          return (
              <div className="animate-fade-in space-y-6">
                  <div className="flex items-center gap-4 mb-4">
                      <button onClick={onBack} className="p-2 bg-white/5 rounded-lg hover:bg-white/10 transition-colors">
                          <Icon name="fa-arrow-left" />
                      </button>
                      <div>
                          <h2 className="text-2xl font-bold text-white">Event Analysis & Logs</h2>
                          <p className="text-textMuted text-sm">Deep dive into active security incidents and audit trails.</p>
                      </div>
                  </div>

                  <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl overflow-hidden shadow-lg">
                      <table className="w-full text-left text-sm">
                          <thead className="bg-white/5 text-textMuted uppercase font-bold tracking-wider text-xs">
                              <tr>
                                  <th className="p-4">Status</th>
                                  <th className="p-4">Event Type</th>
                                  <th className="p-4">Source</th>
                                  <th className="p-4">Assignee</th>
                                  <th className="p-4">Last Updated</th>
                                  <th className="p-4 text-right">Action</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-white/5">
                              {incidents.map((item) => {
                                  const isHighlighted = highlightedId === item.id;
                                  return (
                                      <tr 
                                          key={item.id} 
                                          ref={(el) => { itemRefs.current[item.id] = el }}
                                          className={`group transition-all duration-500 relative hover:bg-white/5 ${isHighlighted ? 'bg-primary/10' : ''}`}
                                      >
                                          <td className="p-4">
                                              <div className={`inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-bold uppercase tracking-wide border ${getStatusColor(item.status)} ${isHighlighted ? 'animate-pulse' : ''}`}>
                                                  <div className={`w-2 h-2 rounded-full ${item.status === 'Open' || item.status === 'Active' ? 'bg-current' : 'bg-current'}`}></div>
                                                  {item.status}
                                              </div>
                                          </td>
                                          <td className="p-4">
                                              <div className="font-bold text-white">{item.title}</div>
                                              <div className="text-xs text-textMuted">{item.desc}</div>
                                          </td>
                                          <td className="p-4 font-mono text-textMuted text-xs">{item.ip}</td>
                                          <td className="p-4">
                                              <div className="flex items-center gap-2">
                                                  {item.assignee ? (
                                                      <>
                                                          <div className="w-5 h-5 rounded-full bg-primary/20 text-primary flex items-center justify-center text-[10px] font-bold">{item.assignee.charAt(0)}</div>
                                                          <span className="text-xs text-white">{item.assignee}</span>
                                                      </>
                                                  ) : (
                                                      <span className="text-xs text-textMuted italic opacity-50">Unassigned</span>
                                                  )}
                                              </div>
                                          </td>
                                          <td className="p-4 text-textMuted text-xs">{item.lastUpdated || item.time}</td>
                                          <td className="p-4 text-right">
                                              <div className="flex items-center justify-end gap-2">
                                                  {!item.assignee && (item.status === 'Open' || item.status === 'Active') && (
                                                      <button 
                                                          onClick={(e) => { e.stopPropagation(); handleClaim(item.id); }}
                                                          className="px-3 py-1.5 rounded-lg bg-primary/10 text-primary border border-primary/20 hover:bg-primary hover:text-black text-xs font-bold transition-all shadow-[0_0_10px_rgba(249,115,22,0.1)]"
                                                      >
                                                          Claim
                                                      </button>
                                                  )}
                                                  <button 
                                                      onClick={(e) => { e.stopPropagation(); handleViewDetails(item); }}
                                                      className="px-3 py-1.5 rounded-lg bg-white/5 text-textMuted border border-white/10 hover:bg-white/10 hover:text-white text-xs font-medium transition-all"
                                                  >
                                                      View
                                                  </button>
                                              </div>
                                          </td>
                                          {isHighlighted && <td className="absolute inset-0 border-2 border-primary/50 pointer-events-none animate-pulse rounded-none"></td>}
                                      </tr>
                                  );
                              })}
                          </tbody>
                      </table>
                  </div>
              </div>
          );
      }

      const EngineerReportsView = ({ reports, onAddReport, onNotify, onEscalate }) => {
          const [isDrafting, setIsDrafting] = useState(true);

          const handleSubmitReport = () => {
              const newReport = { 
                  id: `RPT-25-${Math.floor(2300 + Math.random()*100)}`, 
                  title: 'Coordinated Fraud Ring Analysis', 
                  date: 'Today', 
                  status: 'Pending Review' 
              };
              onAddReport(newReport);
              onNotify(`Report #${newReport.id} submitted to Cindy.`);
              onEscalate({
                  id: Date.now(),
                  title: `Review Fraud Ring Report #${newReport.id}`,
                  requester: 'Andy (Eng)',
                  desc: 'Comprehensive analysis of linked attacks. Critical action required.',
                  type: 'report',
                  icon: 'fa-file-shield',
                  color: 'purple'
              });
              setIsDrafting(false);
          };

          const handleStartNewReport = () => {
              setIsDrafting(true);
          };

          return (
              <div className="animate-fade-in space-y-8">
                  <SectionHeader title="Investigations & Reports" />
                  <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl overflow-hidden shadow-lg">
                      <div className="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                          <h3 className="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2"><Icon name="fa-box-archive" /> Report Registry</h3>
                          <span className="text-[10px] bg-white/10 px-2 py-1 rounded text-textMuted">Total: {reports.length}</span>
                      </div>
                      <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
                          <table className="w-full text-left text-sm">
                              <thead className="bg-black/20 text-textMuted uppercase font-bold tracking-wider text-[10px] sticky top-0 z-10 backdrop-blur-md">
                                  <tr>
                                      <th className="p-3">Report ID</th>
                                      <th className="p-3">Subject</th>
                                      <th className="p-3">Date</th>
                                      <th className="p-3">Status</th>
                                      <th className="p-3 text-right">Action</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-white/5 text-xs">
                                  {reports.map((rpt, i) => (
                                      <tr key={i} className="hover:bg-white/5 transition-colors">
                                          <td className="p-3 font-mono text-primary">{rpt.id}</td>
                                          <td className="p-3 text-white font-medium">{rpt.title}</td>
                                          <td className="p-3 text-textMuted">{rpt.date}</td>
                                          <td className="p-3">
                                              <span className={`px-2 py-0.5 rounded uppercase text-[10px] font-bold border ${
                                                  rpt.status === 'Pending Review' ? 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20' :
                                                  'bg-white/10 text-textMuted border-white/10'
                                              }`}>{rpt.status}</span>
                                          </td>
                                          <td className="p-3 text-right">
                                              <button className="text-textMuted hover:text-white"><Icon name="fa-file-pdf" /></button>
                                          </td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                  </div>

                  <div>
                      <h3 className="text-sm font-bold text-textMuted uppercase tracking-wider mb-4 flex items-center gap-2 pl-2">
                          <Icon name="fa-pen-to-square" className="text-primary" /> Active Workspace
                      </h3>
                      
                      {isDrafting ? (
                          <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-8 shadow-lg relative overflow-hidden group animate-fade-in-up">
                              <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-primary to-orange-600"></div>
                              <div className="flex gap-6 mb-8 border-b border-white/5 pb-8">
                                  <div className="w-16 h-16 bg-gradient-to-br from-primary to-orange-600 rounded-2xl flex items-center justify-center text-black text-2xl shadow-lg shadow-orange-500/20">
                                      <Icon name="fa-file-shield" />
                                  </div>
                                  <div>
                                      <div className="flex items-center gap-3 mb-2">
                                          <h2 className="text-2xl font-bold text-white">Draft: Coordinated Fraud Ring Analysis</h2>
                                          <span className="px-2 py-0.5 bg-yellow-500/20 text-yellow-500 border border-yellow-500/20 rounded text-[10px] font-bold uppercase animate-pulse">In Progress</span>
                                      </div>
                                      <p className="text-textMuted max-w-2xl leading-relaxed text-sm">
                                          Correlating incidents #1 (Credential Stuffing), #2 (Payment Spike), and #6 (Synthetic Loan IDs).
                                          Deep verification indicates a single organized actor leveraging botnets for brute force and synthetic identities for loan applications.
                                      </p>
                                  </div>
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                  <div className="p-4 bg-white/5 rounded-lg border border-white/10 relative group hover:border-white/20 transition-all">
                                      <div className="text-[10px] text-textMuted uppercase tracking-widest mb-2 flex justify-between">Incident #1 <Icon name="fa-link" className="opacity-50" /></div>
                                      <div className="font-bold text-white text-sm">Credential Stuffing</div>
                                      <div className="text-xs text-green-400 mt-2 flex items-center gap-1"><Icon name="fa-check" /> Verified Source IP</div>
                                  </div>
                                  <div className="p-4 bg-white/5 rounded-lg border border-white/10 relative group hover:border-white/20 transition-all">
                                      <div className="text-[10px] text-textMuted uppercase tracking-widest mb-2 flex justify-between">Incident #2 <Icon name="fa-link" className="opacity-50" /></div>
                                      <div className="font-bold text-white text-sm">Payment Velocity</div>
                                      <div className="text-xs text-green-400 mt-2 flex items-center gap-1"><Icon name="fa-check" /> Cards Frozen</div>
                                  </div>
                                  <div className="p-4 bg-purple-500/10 rounded-lg border border-purple-500/30 relative group hover:border-purple-500/50 transition-all">
                                      <div className="text-[10px] text-purple-300 uppercase tracking-widest mb-2 flex justify-between">Incident #6 <Icon name="fa-link" /></div>
                                      <div className="font-bold text-white text-sm">False Loan Apps</div>
                                      <div className="text-xs text-purple-300 mt-2 flex items-center gap-1"><Icon name="fa-check-double" /> Deep Check Complete</div>
                                  </div>
                              </div>

                              <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg mb-8">
                                  <div className="font-bold text-blue-400 mb-1 flex items-center gap-2 text-sm"><Icon name="fa-lightbulb" /> Recommendation to Manager (Cindy)</div>
                                  <p className="text-xs text-blue-200/80 leading-relaxed">Escalate immediately. Recommend instructing Business Manager (Ben) to halt all pending approvals for 'Region-A' applicants until further notice.</p>
                              </div>

                              <div className="flex justify-end gap-4">
                                  <button className="px-6 py-3 bg-white/5 border border-white/10 rounded-lg text-textMuted hover:text-white font-bold transition-all text-xs">Save Draft</button>
                                  <button onClick={handleSubmitReport} className="px-8 py-3 bg-primary text-black font-bold rounded-lg hover:bg-primaryHover transition-all shadow-[0_0_20px_rgba(249,115,22,0.3)] flex items-center gap-2 text-xs"><Icon name="fa-paper-plane" /> Submit Report to Manager</button>
                              </div>
                          </div>
                      ) : (
                          <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-16 shadow-lg flex flex-col items-center justify-center text-center animate-fade-in">
                              <div className="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-6"><Icon name="fa-file-circle-plus" className="text-3xl text-textMuted" /></div>
                              <h3 className="text-xl font-bold text-white mb-2">No Active Investigation</h3>
                              <p className="text-textMuted text-sm max-w-md mb-8">Start a new investigation to correlate incidents, gather evidence, and draft reports for management review.</p>
                              <button onClick={handleStartNewReport} className="px-8 py-3 bg-primary text-black font-bold rounded-lg hover:bg-primaryHover transition-all shadow-[0_0_20px_rgba(249,115,22,0.3)] flex items-center gap-2"><Icon name="fa-plus" /> Start New Report</button>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const EngineerDashboard = ({ onShowModal, incidents, onNavigate }) => {
        const handleRawTraffic = () => {
            onShowModal({
                title: 'Network Packet Inspector',
                body: <RawTrafficViewer />
            });
        };

        const handleIncidentClick = (id) => {
            onNavigate('event_analysis', id);
        };

        return (
          <div className="space-y-6 animate-fade-in">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard title="Suspicious Logins" value="5,420" subtext="Last hour" trend="350%" trendUp={false} icon="fa-arrow-right-to-bracket" color="text-red-500" />
              <StatCard title="Active Incidents" value="2" subtext="Requires Attention" trend="New" trendUp={false} icon="fa-triangle-exclamation" color="text-orange-500" />
              <StatCard title="API Traffic" value="High" subtext="200% above baseline" trend="Spike" trendUp={false} icon="fa-server" color="text-yellow-500" />
              <StatCard title="Firewall Blocks" value="850" subtext="Auto-mitigated" trend="12%" trendUp={true} icon="fa-shield-halved" color="text-green-500" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[500px]">
              <div className="lg:col-span-2 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-6 relative overflow-hidden flex flex-col shadow-lg">
                <SectionHeader title="Global Threat Map" action="View Raw Traffic" onAction={handleRawTraffic} tooltip="Visualizing real-time network packets and geo-location of IP sources." />
                <DynamicThreatMap />
              </div>

              <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-6 flex flex-col shadow-lg">
                 <SectionHeader title="Active Incidents & Threats" tooltip="Prioritized security alerts requiring immediate investigation." />
                 <div className="flex-1 overflow-y-auto pr-2 space-y-3 custom-scrollbar">
                    {incidents.map((item) => (
                      <div 
                          key={item.id} 
                          onClick={() => handleIncidentClick(item.id)} 
                          className={`flex gap-3 items-center group p-3 rounded-lg transition-all cursor-pointer border hover:bg-white/5 hover:border-white/10 ${getStatusColor(item.status)}`}
                      >
                        <div className={`w-2 h-2 rounded-full shrink-0 ${
                          item.status === 'Mitigated' ? 'bg-green-500' :
                          item.status === 'Pending Review' ? 'bg-blue-500 animate-pulse' :
                          item.type === 'critical' ? 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)] animate-pulse' :
                          item.type === 'warning' ? 'bg-orange-500' :
                          item.type === 'alert' ? 'bg-yellow-500' :
                          item.type === 'success' ? 'bg-green-500' : 'bg-blue-500'
                        }`}></div>
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-semibold truncate transition-colors group-hover:text-primary">{item.title}</div>
                          <div className="text-xs opacity-70 truncate">{item.status === 'Mitigated' ? 'Resolved: Blocked & Notified' : item.status === 'Pending Review' ? 'Escalated: Waiting for Approval' : item.desc}</div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            <div className="text-[10px] font-mono opacity-50 bg-black/20 px-1.5 py-0.5 rounded">{item.time}</div>
                            <Icon name="fa-chevron-right" className="text-[10px] opacity-0 group-hover:opacity-100 transition-opacity" />
                        </div>
                      </div>
                    ))}
                 </div>
              </div>
            </div>
          </div>
        );
      };

      // --- MANAGER DASHBOARD COMPONENTS ---
      const REGION_DEFINITIONS = {
          Global: { full: 'Global View', desc: 'Aggregated data from all operational regions.', loc: 'Worldwide' },
          AMER: { full: 'Americas', desc: 'In multinational banks, "AMER" represents markets in North and South America.', loc: 'North America (US, Canada), South America (Brazil, Argentina, Mexico, etc.)' },
          EMEA: { full: 'Europe, Middle East, and Africa', desc: 'Consolidated region for resource and operational integration across these continents.', loc: 'Europe (UK, DE, FR), Middle East (UAE, SA), Africa (ZA, NG, KE)' },
          APAC: { full: 'Asia-Pacific', desc: 'A key market region covering all countries in Asia and Oceania.', loc: 'East Asia (CN, JP, KR), SE Asia (ID, SG, MY), South Asia (IN, PK), Oceania (AU, NZ)' },
          MENA: { full: 'Middle East and North Africa', desc: 'Specific financial distinction often used alongside or within EMEA structures.', loc: 'Middle East (UAE, SA, IL), North Africa (EG, DZ, MA, TN)' }
      };

      const REGION_DATA = {
          Global: {
              impact: { prevented: '$4.2M', preventedTrend: '12%', fraud: '$12.5k', fraudCount: '2 incidents', churn: '$850', topRegion: 'APAC' },
              lifecycle: [
                  { id: 1, title: 'Onboarding', score: 12, avg: 10, status: 'normal', icon: 'fa-id-card', trend: 'stable' },
                  { id: 2, title: 'Access', score: 92, avg: 15, status: 'critical', icon: 'fa-key', trend: 'up' },
                  { id: 3, title: 'Transaction', score: 45, avg: 20, status: 'warning', icon: 'fa-money-bill-transfer', trend: 'up' },
                  { id: 4, title: 'Profile', score: 8, avg: 8, status: 'normal', icon: 'fa-user-pen', trend: 'stable' },
              ],
              strategy: [
                  { label: 'Pass (Auto-Safe)', val: 75, avg: 92, color: 'bg-green-500', text: 'text-green-500' },
                  { label: 'Challenge (Auth)', val: 18, avg: 3, color: 'bg-yellow-500', text: 'text-yellow-500' },
                  { label: 'Block (Threats)', val: 6, avg: 1, color: 'bg-red-500', text: 'text-red-500' },
                  { label: 'Review (Manual)', val: 1, avg: 4, color: 'bg-blue-500', text: 'text-blue-500' },
              ],
              threatLevel: 'CRITICAL'
          },
          APAC: {
              impact: { prevented: '$2.8M', preventedTrend: '18%', fraud: '$11.2k', fraudCount: '1 incident', churn: '$320', topRegion: null },
              lifecycle: [
                  { id: 1, title: 'Onboarding', score: 15, avg: 12, status: 'normal', icon: 'fa-id-card', trend: 'up' },
                  { id: 2, title: 'Access', score: 96, avg: 18, status: 'critical', icon: 'fa-key', trend: 'up' },
                  { id: 3, title: 'Transaction', score: 55, avg: 22, status: 'warning', icon: 'fa-money-bill-transfer', trend: 'up' },
                  { id: 4, title: 'Profile', score: 5, avg: 8, status: 'normal', icon: 'fa-user-pen', trend: 'down' },
              ],
              strategy: [
                  { label: 'Pass', val: 60, avg: 90, color: 'bg-green-500', text: 'text-green-500' },
                  { label: 'Challenge', val: 28, avg: 5, color: 'bg-yellow-500', text: 'text-yellow-500' },
                  { label: 'Block', val: 10, avg: 2, color: 'bg-red-500', text: 'text-red-500' },
                  { label: 'Review', val: 2, avg: 3, color: 'bg-blue-500', text: 'text-blue-500' },
              ],
              threatLevel: 'CRITICAL'
          },
          AMER: {
              impact: { prevented: '$900k', preventedTrend: '5%', fraud: '$0', fraudCount: '0 incidents', churn: '$410', topRegion: null },
              lifecycle: [
                  { id: 1, title: 'Onboarding', score: 8, avg: 9, status: 'normal', icon: 'fa-id-card', trend: 'stable' },
                  { id: 2, title: 'Access', score: 12, avg: 14, status: 'normal', icon: 'fa-key', trend: 'stable' },
                  { id: 3, title: 'Transaction', score: 18, avg: 18, status: 'normal', icon: 'fa-money-bill-transfer', trend: 'stable' },
                  { id: 4, title: 'Profile', score: 6, avg: 7, status: 'normal', icon: 'fa-user-pen', trend: 'stable' },
              ],
              strategy: [
                  { label: 'Pass', val: 94, avg: 94, color: 'bg-green-500', text: 'text-green-500' },
                  { label: 'Challenge', val: 3, avg: 3, color: 'bg-yellow-500', text: 'text-yellow-500' },
                  { label: 'Block', val: 1, avg: 1, color: 'bg-red-500', text: 'text-red-500' },
                  { label: 'Review', val: 2, avg: 2, color: 'bg-blue-500', text: 'text-blue-500' },
              ],
              threatLevel: 'NORMAL'
          },
          EMEA: {
              impact: { prevented: '$450k', preventedTrend: '2%', fraud: '$1.3k', fraudCount: '1 incident', churn: '$120', topRegion: null },
              lifecycle: [
                  { id: 1, title: 'Onboarding', score: 22, avg: 15, status: 'warning', icon: 'fa-id-card', trend: 'up' },
                  { id: 2, title: 'Access', score: 18, avg: 16, status: 'normal', icon: 'fa-key', trend: 'stable' },
                  { id: 3, title: 'Transaction', score: 12, avg: 15, status: 'normal', icon: 'fa-money-bill-transfer', trend: 'down' },
                  { id: 4, title: 'Profile', score: 9, avg: 8, status: 'normal', icon: 'fa-user-pen', trend: 'stable' },
              ],
              strategy: [
                  { label: 'Pass', val: 88, avg: 90, color: 'bg-green-500', text: 'text-green-500' },
                  { label: 'Challenge', val: 5, avg: 4, color: 'bg-yellow-500', text: 'text-yellow-500' },
                  { label: 'Block', val: 2, avg: 2, color: 'bg-red-500', text: 'text-red-500' },
                  { label: 'Review', val: 5, avg: 4, color: 'bg-blue-500', text: 'text-blue-500' },
              ],
              threatLevel: 'ELEVATED'
          },
          MENA: {
              impact: { prevented: '$50k', preventedTrend: '0%', fraud: '$0', fraudCount: '0', churn: '$0', topRegion: null },
              lifecycle: [
                  { id: 1, title: 'Onboarding', score: 5, avg: 5, status: 'normal', icon: 'fa-id-card', trend: 'stable' },
                  { id: 2, title: 'Access', score: 5, avg: 5, status: 'normal', icon: 'fa-key', trend: 'stable' },
                  { id: 3, title: 'Transaction', score: 5, avg: 5, status: 'normal', icon: 'fa-money-bill-transfer', trend: 'stable' },
                  { id: 4, title: 'Profile', score: 5, avg: 5, status: 'normal', icon: 'fa-user-pen', trend: 'stable' },
              ],
              strategy: [
                  { label: 'Pass', val: 98, avg: 95, color: 'bg-green-500', text: 'text-green-500' },
                  { label: 'Challenge', val: 1, avg: 2, color: 'bg-yellow-500', text: 'text-yellow-500' },
                  { label: 'Block', val: 0, avg: 1, color: 'bg-red-500', text: 'text-red-500' },
                  { label: 'Review', val: 1, avg: 2, color: 'bg-blue-500', text: 'text-blue-500' },
              ],
              threatLevel: 'NORMAL'
          }
      };

      const ImpactSummary = ({ data, isGlobal }) => (
        <div className="grid grid-cols-3 gap-[1.5vw] h-full">
          <div className="bg-green-500/10 border border-green-500/20 p-[1.2vw] rounded-xl flex flex-col justify-between relative overflow-hidden group hover:bg-green-500/15 transition-all">
             <div className="absolute top-0 left-0 w-1 h-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
             <div className="flex justify-between items-start">
                <div className="text-[10px] text-green-400 uppercase tracking-widest font-bold">Prevented Loss</div>
                <Icon name="fa-shield-halved" className="text-green-500/50 text-lg" />
             </div>
             <div>
                <div className="text-responsive-2xl font-bold text-white tracking-tight flex items-center gap-3">
                    {data.prevented}
                    {isGlobal && <span className="text-[9px] bg-white/10 text-white px-1.5 py-0.5 rounded border border-white/10 font-normal">Top: APAC</span>}
                </div>
                <div className="text-[10px] text-green-400/60 mt-1 flex items-center gap-1 font-mono">
                   <Icon name="fa-arrow-up" className="text-[9px]"/> {data.preventedTrend} vs last week
                </div>
             </div>
          </div>

          <div className="bg-red-500/10 border border-red-500/20 p-[1.2vw] rounded-xl flex flex-col justify-between relative overflow-hidden group hover:bg-red-500/15 transition-all">
             <div className="absolute top-0 left-0 w-1 h-full bg-red-500 shadow-[0_0_10px_#ef4444]"></div>
             <div className="flex justify-between items-start">
                <div className="text-[10px] text-red-400 uppercase tracking-widest font-bold">Actual Fraud Loss</div>
                <Icon name="fa-triangle-exclamation" className="text-red-500/50 text-lg" />
             </div>
             <div>
                <div className="text-responsive-2xl font-bold text-white tracking-tight flex items-center gap-3">
                    {data.fraud}
                    {isGlobal && <span className="text-[9px] bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded border border-red-500/20 font-normal">Top: APAC</span>}
                </div>
                <div className="text-[10px] text-red-400/60 mt-1 flex items-center gap-1 font-mono">
                   {data.fraudCount}
                </div>
             </div>
          </div>

          <div className="bg-yellow-500/10 border border-yellow-500/20 p-[1.2vw] rounded-xl flex flex-col justify-between relative overflow-hidden group hover:bg-yellow-500/15 transition-all">
             <div className="absolute top-0 left-0 w-1 h-full bg-yellow-500 shadow-[0_0_10px_#eab308]"></div>
             <div className="flex justify-between items-start">
                <div className="text-[10px] text-yellow-400 uppercase tracking-widest font-bold">False Positive Cost</div>
                <Icon name="fa-user-slash" className="text-yellow-500/50 text-lg" />
             </div>
             <div>
                <div className="text-responsive-2xl font-bold text-white tracking-tight">{data.churn}</div>
                <div className="text-[10px] text-yellow-400/60 mt-1 flex items-center gap-1 font-mono">
                   Est. churn risk
                </div>
             </div>
          </div>
        </div>
      );

      const SystemThreatLevel = ({ level }) => {
          const isCritical = level === 'CRITICAL';
          const isElevated = level === 'ELEVATED';
          
          const tooltipColor = isCritical ? 'text-red-500' : isElevated ? 'text-yellow-500' : 'text-green-500';
          const slaText = isCritical ? 'Immediate Action (< 15m)' : isElevated ? 'High Priority (< 1h)' : 'Normal Monitoring';
          
          return (
              <div className={`
                  bg-gradient-to-br backdrop-blur-md border rounded-xl p-[1.2vw] relative group h-full flex flex-col justify-center z-20
                  ${isCritical ? 'from-red-500/20 via-surface/60 to-surface/40 border-red-500/30' : 
                    isElevated ? 'from-yellow-500/20 via-surface/60 to-surface/40 border-yellow-500/30' :
                    'from-green-500/20 via-surface/60 to-surface/40 border-green-500/30'}
              `}>
                  <div className={`absolute inset-0 transition-colors rounded-xl pointer-events-none ${isCritical ? 'bg-red-500/5 group-hover:bg-red-500/10' : 'bg-green-500/5'}`}></div>
                  
                  <div className="relative flex items-center justify-between mb-2">
                      <div className="flex items-center gap-3">
                          <div className={`p-2 text-white rounded-lg text-lg shadow-lg shrink-0 ${isCritical ? 'bg-red-500 animate-pulse-fast' : isElevated ? 'bg-yellow-500' : 'bg-green-500'}`}>
                              <Icon name="fa-bolt" />
                          </div>
                          <div className="font-bold text-xs text-white uppercase tracking-wider opacity-80">Threat Level</div>
                      </div>
                      
                      <div className="relative group/info">
                          <Icon name="fa-circle-info" className="text-white/30 hover:text-white cursor-pointer p-1" />
                          <div className="absolute right-[-10px] top-8 w-64 bg-surfaceHighlight border border-white/20 p-4 rounded-xl shadow-[0_10px_40px_rgba(0,0,0,0.8)] opacity-0 group-hover/info:opacity-100 transition-opacity pointer-events-none group-hover/info:pointer-events-auto z-50">
                              <div className="text-xs font-bold text-white mb-3 pb-2 border-b border-white/10 flex justify-between">
                                  <span>Level Definition</span>
                                  <span className={tooltipColor}>{level}</span>
                              </div>
                              <ul className="text-[10px] text-textMuted space-y-2 list-disc pl-3">
                                  {isCritical ? (
                                      <Fragment>
                                          <li>Global Failed Logins <span className="text-red-400 font-mono">&gt; 5,000/min</span></li>
                                          <li>Automated Attack Signatures Detected</li>
                                      </Fragment>
                                  ) : isElevated ? (
                                      <Fragment>
                                          <li>Traffic Anomaly <span className="text-yellow-400 font-mono">&gt; 200% Baseline</span></li>
                                          <li>Multiple Region Alerts</li>
                                      </Fragment>
                                  ) : (
                                      <li>All systems operating within normal parameters.</li>
                                  )}
                                  <li>Response SLA: <span className={`text-white px-1 rounded ${isCritical ? 'bg-red-500/20' : 'bg-white/10'}`}>{slaText}</span></li>
                              </ul>
                              <div className="mt-3 pt-2 border-t border-white/5 text-[9px] text-textMuted/50 italic text-center">
                                  Auto-calculated by Risk Engine v3.0
                              </div>
                          </div>
                      </div>
                  </div>

                  <div className="relative">
                      <div className={`text-3xl lg:text-4xl font-bold leading-none tracking-tighter shadow-black drop-shadow-md ${isCritical ? 'text-red-500' : isElevated ? 'text-yellow-500' : 'text-green-500'}`}>
                          {level}
                      </div>
                      {isCritical && (
                          <div className="mt-2 inline-flex items-center gap-2 bg-black/40 px-2 py-1 rounded border border-red-500/20 max-w-full">
                              <Icon name="fa-triangle-exclamation" className="text-red-500 text-[10px] shrink-0"/> 
                              <span className="text-[10px] text-textMuted truncate">Credential Stuffing</span>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const LifecycleRiskMonitor = ({ steps }) => {
        const getStatusStyles = (s) => {
            if (s === 'critical') return { 
                bg: 'bg-red-500/10', border: 'border-red-500/50', text: 'text-red-500', 
                shadow: 'shadow-[0_0_15px_rgba(239,68,68,0.2)]', iconBg: 'bg-red-500',
                bar: 'bg-red-500' 
            };
            if (s === 'warning') return { 
                bg: 'bg-yellow-500/10', border: 'border-yellow-500/50', text: 'text-yellow-500', 
                shadow: 'shadow-none', iconBg: 'bg-yellow-500',
                bar: 'bg-yellow-500'
            };
            return { 
                bg: 'bg-green-500/5', border: 'border-green-500/30', text: 'text-white', 
                shadow: 'shadow-none', iconBg: 'bg-green-500',
                bar: 'bg-green-500'
            };
        };

        return (
          <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-[1.5vw] shadow-lg h-full flex flex-col justify-center overflow-hidden">
              <div className="flex items-center justify-between mb-4">
                  <SectionHeader 
                      title="Lifecycle Risk Index" 
                      tooltip="Normalized Risk Score (0-100) based on aggregated threat signals."
                  />
                  <div className="group relative flex items-center gap-2 cursor-help">
                      <span className="text-[10px] text-textMuted uppercase tracking-widest">Index Scale</span>
                      <div className="flex gap-0.5">
                          <div className="w-2 h-2 bg-green-500 rounded-sm"></div>
                          <div className="w-2 h-2 bg-yellow-500 rounded-sm"></div>
                          <div className="w-2 h-2 bg-red-500 rounded-sm"></div>
                      </div>
                      <div className="absolute right-0 top-6 w-48 bg-surfaceHighlight border border-white/20 p-3 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                          <div className="text-[10px] font-bold text-white mb-2 border-b border-white/10 pb-1">Risk Score Interpretation</div>
                          <div className="space-y-1.5 text-[9px]">
                              <div className="flex justify-between text-green-400"><span>0 - 20</span> <span>Safe / Normal</span></div>
                              <div className="flex justify-between text-yellow-400"><span>21 - 50</span> <span>Elevated</span></div>
                              <div className="flex justify-between text-orange-400"><span>51 - 80</span> <span>High Risk</span></div>
                              <div className="flex justify-between text-red-500 font-bold"><span>81 - 100</span> <span>Critical</span></div>
                          </div>
                          <div className="mt-2 text-[8px] text-textMuted italic">Higher score indicates higher probability of fraud.</div>
                      </div>
                  </div>
              </div>

              <div className="flex-1 flex items-center w-full">
                  <div className="flex items-stretch justify-between relative gap-4 w-full h-full max-h-[140px]">
                      {steps.map((step) => {
                          const styles = getStatusStyles(step.status);
                          const deviation = step.score - step.avg;
                          const isSpike = deviation > 10;

                          return (
                              <div key={step.id} className={`flex-1 flex flex-col justify-between bg-background/90 p-3 rounded-xl border transition-all relative overflow-hidden group ${styles.border} ${styles.bg} ${styles.shadow}`}>
                                  <div className="flex justify-between items-center z-10 shrink-0">
                                      <div className="flex items-center gap-2">
                                          <div className={`w-5 h-5 rounded flex items-center justify-center text-[10px] text-black font-bold ${styles.iconBg}`}>
                                              <Icon name={step.icon} />
                                          </div>
                                          <span className="text-[10px] font-bold text-textMuted uppercase tracking-wider truncate">{step.title}</span>
                                      </div>
                                      {step.status === 'critical' && <Icon name="fa-triangle-exclamation" className="text-red-500 text-xs animate-pulse" />}
                                  </div>

                                  <div className="z-10 mt-2 flex-1 flex flex-col justify-center">
                                      <div className="flex items-baseline gap-1">
                                          <span className={`text-2xl lg:text-3xl font-bold leading-none ${styles.text}`}>{step.score}</span>
                                          <span className="text-[10px] text-textMuted font-mono">/100</span>
                                      </div>
                                      
                                      <div className="flex items-center gap-2 mt-1 text-[10px]">
                                          <span className="text-textMuted opacity-60">Avg: {step.avg}</span>
                                          {isSpike ? (
                                              <span className={`px-1.5 rounded flex items-center gap-1 font-bold ${step.status === 'critical' ? 'bg-red-500 text-black' : 'bg-yellow-500 text-black'}`}>
                                                  <Icon name="fa-arrow-trend-up" /> +{deviation}
                                              </span>
                                          ) : (
                                              <span className="text-green-500 flex items-center gap-1"><Icon name="fa-minus" /> Stable</span>
                                          )}
                                      </div>
                                  </div>

                                  <div className="mt-2 w-full h-1 bg-black/50 rounded-full overflow-hidden z-10 shrink-0">
                                      <div style={{width: `${step.score}%`}} className={`h-full rounded-full transition-all duration-1000 ${styles.bar}`}></div>
                                  </div>
                                  <div className="absolute bottom-[16px] w-0.5 h-2 bg-white/50 z-20" style={{left: `calc(${step.avg}% + 12px)`}} title="Historical Average"></div>
                              </div>
                          );
                      })}
                  </div>
              </div>
          </div>
        );
      };

      const DefenseStrategyPanel = ({ strategies }) => {
          return (
              <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-[1.5vw] shadow-lg h-full flex flex-col">
                  <SectionHeader title="Defense Strategy Distribution" tooltip="Current vs Baseline (Grey Marker)" />
                  <div className="flex-1 flex flex-col justify-center space-y-3">
                      {strategies.map((s, i) => {
                          const isSpike = s.val > s.avg * 1.5;
                          const isDrop = s.val < s.avg * 0.8;
                          
                          return (
                              <div key={i} className="group">
                                  <div className="flex justify-between text-xs mb-1">
                                      <span className={`font-medium ${s.val > s.avg ? 'text-white' : 'text-textMuted'}`}>{s.label}</span>
                                      <div className="flex gap-2 font-mono">
                                          <span className={`${s.text} font-bold`}>{s.val}%</span>
                                          <span className="text-textMuted/40 text-[9px] mt-0.5">Avg: {s.avg}%</span>
                                      </div>
                                  </div>

                                  <div className="relative h-2.5 w-full bg-black/40 rounded-full overflow-visible border border-white/5">
                                      <div 
                                          style={{width: `${s.val}%`}} 
                                          className={`absolute top-0 left-0 h-full rounded-full ${s.color} opacity-90 group-hover:opacity-100 transition-all duration-700`}
                                      ></div>
                                      <div 
                                          style={{left: `${s.avg}%`}} 
                                          className="absolute top-[-3px] bottom-[-3px] w-1 bg-white shadow-[0_0_5px_rgba(255,255,255,0.8)] z-10"
                                          title={`Historical Average: ${s.avg}%`}
                                      ></div>
                                      {isSpike && (
                                          <div 
                                              style={{left: `${s.avg}%`, width: `${s.val - s.avg}%`}}
                                              className="absolute top-0 h-full bg-[url('https://www.transparenttextures.com/patterns/diagonal-striped-brick.png')] opacity-30 z-0 animate-pulse"
                                          ></div>
                                      )}
                                  </div>

                                  <div className="h-3 relative">
                                      {isSpike && (
                                          <span className="absolute right-0 text-[8px] font-bold text-yellow-500 flex items-center gap-1 animate-pulse top-[-2px]">
                                              <Icon name="fa-caret-up" /> Surge Detected
                                          </span>
                                      )}
                                      {isDrop && (
                                          <span className="absolute right-0 text-[8px] text-textMuted flex items-center gap-1 opacity-50 top-[-2px]">
                                              <Icon name="fa-caret-down" /> Below Normal
                                          </span>
                                      )}
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              </div>
          );
      };

      const PendingDecisionsPanel = ({ decisions, onNavigate }) => {
          return (
              <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-[1.5vw] shadow-lg flex flex-col h-full min-h-0">
                   <SectionHeader 
                      title="Pending Decisions" 
                      action="Process in Hub" 
                      onAction={() => onNavigate('decision_hub', null)}
                      tooltip="Review and process pending security decisions in the Decision Hub."
                   />
                   <div className="flex-1 overflow-auto custom-scrollbar relative">
                     {decisions.length === 0 ? (
                       <div className="flex flex-col items-center justify-center h-full text-textMuted">
                         <div className="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center mb-3">
                            <Icon name="fa-check" className="text-xl text-green-500" />
                         </div>
                         <span className="text-sm">All pending decisions cleared.</span>
                       </div>
                     ) : (
                       <div className="space-y-2 pb-2">
                          <div className="grid grid-cols-12 text-[10px] uppercase text-textMuted font-bold px-4 pb-2 border-b border-white/5 sticky top-0 bg-[#121214] z-10 backdrop-blur-md">
                              <div className="col-span-5">Request / Campaign</div>
                              <div className="col-span-3">Source</div>
                              <div className="col-span-3">Impact</div>
                              <div className="col-span-1 text-right"></div>
                          </div>
                          {decisions.slice(0, 10).map(d => (
                              <div 
                                  key={d.id} 
                                  onClick={() => onNavigate('decision_hub', d.id)}
                                  className="grid grid-cols-12 items-center p-3 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 hover:border-primary/30 transition-all cursor-pointer group"
                              >
                                  <div className="col-span-5 flex items-center gap-3 min-w-0">
                                      <div className={`w-8 h-8 flex items-center justify-center bg-${d.color || (d.campaignMeta ? d.campaignMeta.color : 'gray')}-500/20 text-${d.color || (d.campaignMeta ? d.campaignMeta.color : 'gray')}-500 rounded-lg shrink-0`}>
                                          <Icon name={d.icon || (d.campaignMeta ? d.campaignMeta.icon : 'fa-circle')} />
                                      </div>
                                      <div className="min-w-0 flex-1">
                                          <div className="font-bold text-xs text-white group-hover:text-primary transition-colors truncate" title={d.campaignId ? d.campaignMeta.title : d.title}>
                                              {d.campaignId ? d.campaignMeta.title : d.title}
                                          </div>
                                          <div className="text-[10px] text-textMuted truncate pr-2">
                                              {d.campaignId ? 'Campaign Bundle' : d.desc}
                                          </div>
                                      </div>
                                  </div>
                                  <div className="col-span-3 text-xs text-textMuted truncate">
                                      {d.requester}
                                  </div>
                                  <div className="col-span-3">
                                      {d.impact && (
                                          <span className="text-[10px] text-green-400 font-mono bg-green-500/10 px-2 py-0.5 rounded border border-green-500/10 truncate inline-block max-w-full">
                                              {d.impact}
                                          </span>
                                      )}
                                  </div>
                                  <div className="col-span-1 text-right">
                                      <Icon name="fa-chevron-right" className="text-[10px] text-textMuted group-hover:text-white" />
                                  </div>
                              </div>
                          ))}
                          {decisions.length > 10 && (
                              <div className="text-center pt-2 pb-2">
                                  <button onClick={() => onNavigate('decision_hub', null)} className="text-xs text-textMuted hover:text-white underline">
                                      View {decisions.length - 10} more...
                                  </button>
                              </div>
                          )}
                       </div>
                     )}
                   </div>
              </div>
          );
      };

      const TeamOperationsPanel = () => {
          return (
              <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-[1.5vw] shadow-lg h-full flex flex-col">
                  <div className="flex justify-between items-start mb-4">
                      <SectionHeader title="Team Operations" />
                      <div className="relative group/sla cursor-help">
                          <div className="flex items-center gap-2 px-2 py-1 rounded bg-blue-500/10 border border-blue-500/20">
                              <span className="text-[10px] text-blue-400 font-bold uppercase tracking-wider">SLA Status</span>
                              <span className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                          </div>
                          <div className="absolute right-0 top-8 w-56 bg-surfaceHighlight border border-white/20 p-3 rounded-xl shadow-xl opacity-0 group-hover/sla:opacity-100 transition-opacity pointer-events-none z-50">
                              <div className="text-[10px] font-bold text-white mb-2 border-b border-white/10 pb-1">Service Level Agreements</div>
                              <ul className="text-[9px] text-textMuted space-y-1.5">
                                  <li className="flex justify-between"><span>Response Target:</span> <span className="text-white">&lt; 2 Hours</span></li>
                                  <li className="flex justify-between"><span>Current Compliance:</span> <span className="text-green-400">98%</span></li>
                                  <li className="flex justify-between"><span>Shift Capacity:</span> <span className="text-yellow-400">High Load</span></li>
                              </ul>
                          </div>
                      </div>
                  </div>
                  
                  <div className="flex flex-col gap-4 flex-1 min-h-0">
                      <div className="flex items-center gap-4 bg-white/5 p-3 rounded-lg border border-white/5">
                          <div className="relative w-14 h-14 shrink-0">
                             <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
                                 <circle cx="50" cy="50" r="40" stroke="currentColor" strokeWidth="12" fill="transparent" className="text-white/5" />
                                 <circle cx="50" cy="50" r="40" stroke="currentColor" strokeWidth="12" fill="transparent" strokeDasharray="251" strokeDashoffset="70" className="text-blue-500" strokeLinecap="round" />
                             </svg>
                             <div className="absolute inset-0 flex flex-col items-center justify-center">
                                 <span className="text-sm font-bold text-white">72%</span>
                             </div>
                          </div>
                          <div className="flex-1">
                              <div className="text-xs text-white font-bold mb-0.5">Response Time Target</div>
                              <div className="flex gap-4 text-[10px] text-textMuted">
                                  <div>Backlog: <span className="text-white font-mono">45</span></div>
                                  <div>Avg Time: <span className="text-white font-mono">1.8h</span></div>
                              </div>
                          </div>
                      </div>

                      <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                         {[
                           { name: 'Andy Gunn', role: 'Sec. Engineer', status: 'Busy', load: 95, avatar: 'AG' },
                           { name: 'Sarah Lee', role: 'Analyst', status: 'Available', load: 30, avatar: 'SL' },
                           { name: 'Mike Ross', role: 'Compliance', status: 'Meeting', load: 45, avatar: 'MR' },
                         ].map((member, i) => (
                           <div key={i} className="flex items-center gap-3 pb-2 border-b border-white/5 last:border-0">
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-white/10 to-white/5 border border-white/10 flex items-center justify-center text-[10px] font-bold text-white shadow-inner">
                                 {member.avatar}
                              </div>
                              <div className="flex-1">
                                 <div className="text-xs font-bold text-white">{member.name}</div>
                                 <div className="text-[9px] text-textMuted">{member.role}</div>
                              </div>
                              <div className="text-right">
                                 <div className={`text-[9px] font-bold px-1.5 py-0.5 rounded uppercase inline-block mb-1 ${
                                   member.status === 'Busy' ? 'bg-red-500/20 text-red-400 border border-red-500/20' :
                                   member.status === 'Available' ? 'bg-green-500/20 text-green-400 border border-green-500/20' : 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/20'
                                 }`}>{member.status}</div>
                                 <div className="w-12 h-1 bg-black/50 rounded-full overflow-hidden border border-white/5 ml-auto">
                                    <div style={{width: `${member.load}%`}} className={`h-full rounded-full ${member.load > 80 ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                 </div>
                              </div>
                           </div>
                         ))}
                      </div>
                  </div>
              </div>
          );
      };

      const ManagerDashboard = ({ onNotify, decisions, onNavigate }) => {
        const [activeRegion, setActiveRegion] = useState('Global');
        const currentData = REGION_DATA[activeRegion] || REGION_DATA['Global'];

        return (
          <div className="flex flex-col h-full gap-[2vh] animate-fade-in pb-6">
            <div className="bg-surface/30 backdrop-blur-sm border border-white/5 rounded-2xl p-4 shadow-2xl flex flex-col gap-4">
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-3">
                        <div className="w-1 h-6 bg-primary rounded-full shadow-[0_0_10px_rgba(249,115,22,0.5)]"></div>
                        <h2 className="text-xl font-bold text-white tracking-tight">Regional Security Posture</h2>
                    </div>
                    
                    <div className="relative group/dropdown z-50">
                        <div className="flex items-center gap-2 bg-black/40 border border-white/10 px-3 py-1.5 rounded-lg hover:border-white/30 transition-all cursor-pointer">
                            <Icon name="fa-globe" className="text-textMuted text-xs" />
                            <span className="text-sm font-bold text-white min-w-[60px] text-center">{activeRegion}</span>
                            <Icon name="fa-chevron-down" className="text-[10px] text-textMuted" />
                        </div>
                        <div className="absolute right-0 top-full mt-2 w-64 bg-[#18181b] border border-white/10 rounded-xl shadow-2xl overflow-hidden opacity-0 invisible group-hover/dropdown:opacity-100 group-hover/dropdown:visible transition-all duration-200 transform origin-top-right">
                            {Object.keys(REGION_DEFINITIONS).map((key) => (
                                <div 
                                  key={key} 
                                  onClick={() => setActiveRegion(key)}
                                  className={`p-3 hover:bg-white/5 cursor-pointer border-b border-white/5 last:border-0 group/item ${activeRegion === key ? 'bg-primary/10' : ''}`}
                                >
                                    <div className="flex justify-between items-center mb-1">
                                        <span className={`text-xs font-bold ${activeRegion === key ? 'text-primary' : 'text-white'}`}>{key}</span>
                                    </div>
                                    <div className="text-[10px] text-textMuted group-hover/item:text-white transition-colors line-clamp-2">
                                        {REGION_DEFINITIONS[key].full}
                                    </div>
                                    <div className="absolute right-full top-0 mr-2 w-64 bg-surfaceHighlight border border-white/20 p-4 rounded-xl shadow-xl opacity-0 group-hover/item:opacity-100 pointer-events-none transition-opacity z-[60]">
                                        <div className="text-xs font-bold text-white mb-2 pb-2 border-b border-white/10 flex items-center gap-2">
                                            <Icon name="fa-map-location-dot" className="text-primary"/> {REGION_DEFINITIONS[key].full}
                                        </div>
                                        <div className="space-y-3">
                                            <div>
                                                <span className="text-[9px] text-textMuted uppercase font-bold block mb-0.5">Coverage</span>
                                                <p className="text-[10px] text-gray-300 leading-tight">{REGION_DEFINITIONS[key].loc}</p>
                                            </div>
                                            <div>
                                                <span className="text-[9px] text-textMuted uppercase font-bold block mb-0.5">Context</span>
                                                <p className="text-[10px] text-gray-300 leading-tight">{REGION_DEFINITIONS[key].desc}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-4 gap-[1.5vw] min-h-[140px]">
                    <div className="lg:col-span-3">
                        <ImpactSummary data={currentData.impact} isGlobal={activeRegion === 'Global'} />
                    </div>
                    <div className="lg:col-span-1">
                        <SystemThreatLevel level={currentData.threatLevel} />
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-[1.5vw] min-h-[220px]">
                    <div className="lg:col-span-2">
                        <LifecycleRiskMonitor steps={currentData.lifecycle} />
                    </div>
                    <div className="lg:col-span-1">
                        <DefenseStrategyPanel strategies={currentData.strategy} />
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-[1.5vw] flex-1 min-h-0">
                <div className="lg:col-span-2">
                   <PendingDecisionsPanel decisions={decisions} onNavigate={onNavigate} />
                </div>
                <div className="lg:col-span-1">
                    <TeamOperationsPanel />
                </div>
            </div>
          </div>
        );
      };

      const DecisionHubView = ({ decisions, highlightedId, onNotify, onProcessDecision }) => {
          const [selectedId, setSelectedId] = useState(null);
          const [activeTab, setActiveTab] = useState('campaigns');
          const itemRefs = useRef({});

          useEffect(() => {
              if (highlightedId) {
                  setSelectedId(highlightedId);
                   setTimeout(() => {
                      const el = itemRefs.current[highlightedId];
                      if (el) {
                          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      }
                  }, 200);
              }
          }, [highlightedId]);

          const handleAction = (id, status) => {
              onProcessDecision(id, status);
              onNotify(`Decision processed: ${status}`);
          };

          const handleBulkDecision = (ids, status) => {
              ids.forEach(id => onProcessDecision(id, status));
              onNotify(`Bulk Action: ${status} applied to ${ids.length} items.`);
          };

          const groupedCampaigns = {};
          const ungroupedItems = [];

          decisions.forEach(item => {
              if (item.campaignId) {
                  if (!groupedCampaigns[item.campaignId]) {
                      groupedCampaigns[item.campaignId] = {
                          meta: item.campaignMeta,
                          items: []
                      };
                  }
                  groupedCampaigns[item.campaignId].items.push(item);
              } else {
                  ungroupedItems.push(item);
              }
          });

          return (
              <div className="flex flex-col h-full gap-6 animate-fade-in pb-2">
                   <style dangerouslySetInnerHTML={{__html: `
                      @keyframes shadow-pulse {
                          0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); border-color: rgba(249, 115, 22, 0.8); }
                          70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); border-color: rgba(249, 115, 22, 0.4); }
                          100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); border-color: rgba(249, 115, 22, 0.8); }
                      }
                      .highlight-pulse {
                          animation: shadow-pulse 2s infinite;
                      }
                  `}} />
                  <div className="flex items-center justify-between shrink-0">
                      <div>
                          <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                              <Icon name="fa-gavel" className="text-primary" />
                              Decision Governance Hub
                          </h1>
                          <p className="text-textMuted text-sm mt-1 ml-9">Centralized processing for security campaigns and exceptions.</p>
                      </div>
                      <div className="bg-black/40 p-1 rounded-lg border border-white/10 flex text-sm font-bold">
                          <button 
                          onClick={() => setActiveTab('campaigns')}
                          className={`px-6 py-2 rounded-md transition-all flex items-center gap-2 ${activeTab === 'campaigns' ? 'bg-primary text-black shadow-lg shadow-primary/20' : 'text-textMuted hover:text-white'}`}
                          >
                          <Icon name="fa-layer-group" /> Campaign View
                          </button>
                          <button 
                          onClick={() => setActiveTab('items')}
                          className={`px-6 py-2 rounded-md transition-all flex items-center gap-2 ${activeTab === 'items' ? 'bg-primary text-black shadow-lg shadow-primary/20' : 'text-textMuted hover:text-white'}`}
                          >
                          <Icon name="fa-list-check" /> Item View
                          </button>
                      </div>
                  </div>

                  <div className="flex h-full gap-6 overflow-hidden">
                      <div className="flex-1 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl shadow-lg overflow-hidden flex flex-col">
                           <div className="p-6 bg-white/5 border-b border-white/5 flex justify-between items-center">
                              <div className="flex gap-4 text-xs font-bold text-textMuted uppercase tracking-widest">
                                  <span>Active Requests: <span className="text-white">{decisions.filter(d => d.status === 'Pending').length}</span></span>
                                  <span>Pending Value: <span className="text-green-400">$4.2M</span></span>
                              </div>
                          </div>

                          <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
                              {decisions.length === 0 ? (
                                  <div className="flex flex-col items-center justify-center h-full text-textMuted opacity-60">
                                      <Icon name="fa-clipboard-check" className="text-4xl mb-4" />
                                      <p>No records found.</p>
                                  </div>
                              ) : (
                                  <div className="space-y-6">
                                      {activeTab === 'campaigns' && Object.entries(groupedCampaigns).map(([id, group]) => (
                                          <div key={id} className="bg-purple-500/5 border border-purple-500/20 rounded-xl overflow-hidden group/card shadow-lg">
                                              <div className="p-4 bg-purple-500/10 border-b border-purple-500/10 flex items-center justify-between">
                                                  <div className="flex items-center gap-4">
                                                      <div className="w-10 h-10 rounded-xl bg-purple-500/20 text-purple-400 flex items-center justify-center text-lg shadow-inner">
                                                          <Icon name={group.meta.icon} />
                                                      </div>
                                                      <div>
                                                          <div className="text-base font-bold text-white flex items-center gap-3">
                                                              {group.meta.title}
                                                              <span className="text-[10px] bg-purple-500 text-black px-2 py-0.5 rounded font-bold uppercase tracking-wide">Campaign</span>
                                                          </div>
                                                          <div className="text-xs text-textMuted mt-0.5">{group.meta.desc}</div>
                                                      </div>
                                                  </div>
                                                  <div className="flex gap-3">
                                                      {group.items.some((i) => i.status === 'Pending') && (
                                                          <Fragment>
                                                              <button 
                                                                  onClick={() => handleBulkDecision(group.items.filter((i) => i.status === 'Pending').map((i) => i.id), 'Rejected')} 
                                                                  className="px-4 py-2 text-xs font-bold bg-black/20 border border-white/10 rounded-lg hover:bg-white/5 text-textMuted hover:text-white transition-colors"
                                                              >
                                                                  Reject Remaining
                                                              </button>
                                                              <button 
                                                                  onClick={() => handleBulkDecision(group.items.filter((i) => i.status === 'Pending').map((i) => i.id), 'Approved')} 
                                                                  className="px-4 py-2 text-xs font-bold bg-purple-600 text-white rounded-lg hover:bg-purple-500 shadow-[0_0_15px_rgba(147,51,234,0.4)] transition-all flex items-center gap-2"
                                                              >
                                                                  <Icon name="fa-check-double" /> Approve Campaign
                                                              </button>
                                                          </Fragment>
                                                      )}
                                                  </div>
                                              </div>
                                              
                                              <div className="bg-black/20">
                                                  {group.items.map((item) => (
                                                      <div 
                                                          key={item.id}
                                                          ref={(el) => { itemRefs.current[item.id] = el }}
                                                          className={`
                                                              flex items-center justify-between p-4 border-b border-white/5 last:border-0 transition-all duration-300 group/item
                                                              ${highlightedId === item.id ? 'bg-primary/10 border-l-4 border-primary highlight-pulse z-10 relative' : 'hover:bg-white/5'}
                                                              ${item.status !== 'Pending' ? 'opacity-70 grayscale-[0.3]' : ''}
                                                          `}
                                                      >
                                                          <div className="flex items-center gap-4">
                                                              <div className="w-8 flex justify-center text-textMuted opacity-50"><Icon name={item.type === 'ban' ? 'fa-ban' : 'fa-file'} /></div>
                                                              <div>
                                                                  <div className={`text-sm font-medium ${item.status !== 'Pending' ? 'text-textMuted line-through decoration-white/20' : 'text-white'}`}>{item.title}</div>
                                                                  <div className="text-xs text-textMuted flex gap-2 mt-0.5">
                                                                      <span>Req: {item.requester}</span>
                                                                      <span className="text-white/20"></span>
                                                                      <span>Today</span>
                                                                  </div>
                                                              </div>
                                                          </div>
                                                          
                                                          <div className="flex items-center gap-6">
                                                              {item.impact && (
                                                                  <span className="text-xs font-mono text-green-400 bg-green-400/10 px-3 py-1 rounded border border-green-400/20 flex items-center gap-2">
                                                                      <Icon name="fa-arrow-trend-up" /> {item.impact}
                                                                  </span>
                                                              )}
                                                              
                                                              {item.status !== 'Pending' ? (
                                                                  <div className={`px-3 py-1 rounded text-xs font-bold border flex items-center gap-2
                                                                      ${item.status === 'Approved' ? 'bg-green-500/20 text-green-400 border-green-500/20' : 
                                                                        item.status === 'Rejected' ? 'bg-red-500/20 text-red-400 border-red-500/20' : 
                                                                        'bg-blue-500/20 text-blue-400 border-blue-500/20'}`}>
                                                                      <Icon name={item.status === 'Approved' ? 'fa-check' : item.status === 'Rejected' ? 'fa-ban' : 'fa-share'} /> {item.status}
                                                                  </div>
                                                              ) : (
                                                                  <div className="flex gap-2 opacity-50 group-hover/item:opacity-100 transition-opacity">
                                                                      <button onClick={() => handleAction(item.id, 'Rejected')} className="p-2 hover:bg-white/10 rounded text-textMuted hover:text-white" title="Reject"><Icon name="fa-xmark"/></button>
                                                                      <button onClick={() => handleAction(item.id, 'Escalated')} className="p-2 hover:bg-blue-500/20 rounded text-textMuted hover:text-blue-400" title="Escalate"><Icon name="fa-share"/></button>
                                                                      <button onClick={() => handleAction(item.id, 'Approved')} className="p-2 hover:bg-green-500/20 rounded text-textMuted hover:text-green-400" title="Approve"><Icon name="fa-check"/></button>
                                                                  </div>
                                                              )}
                                                          </div>
                                                      </div>
                                                  ))}
                                              </div>
                                          </div>
                                      ))}

                                      {activeTab === 'campaigns' && ungroupedItems.length > 0 && (
                                          <div className="mt-8">
                                              <div className="text-xs font-bold text-textMuted uppercase tracking-widest mb-4 pl-1">Individual Requests</div>
                                              {ungroupedItems.map(item => (
                                                  <div 
                                                      key={item.id}
                                                      ref={(el) => { itemRefs.current[item.id] = el }}
                                                      className={`
                                                          flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/5 transition-all mb-3 group
                                                          ${highlightedId === item.id ? 'bg-primary/10 border-l-4 border-primary highlight-pulse z-10 relative' : 'hover:border-primary/30'}
                                                          ${item.status !== 'Pending' ? 'opacity-70' : ''}
                                                      `}
                                                  >
                                                      <div className="flex items-center gap-4">
                                                          <div className={`w-10 h-10 flex items-center justify-center bg-${item.color}-500/20 text-${item.color}-500 rounded-lg shadow-sm`}><Icon name={item.icon} /></div>
                                                          <div>
                                                              <div className={`font-bold text-sm ${item.status !== 'Pending' ? 'text-textMuted line-through decoration-white/20' : 'text-white'}`}>{item.title}</div>
                                                              <div className="text-xs text-textMuted mt-0.5"><span className="text-primary font-bold mr-1">{item.requester}:</span>{item.desc}</div>
                                                          </div>
                                                      </div>
                                                      <div className="flex items-center gap-4">
                                                          {item.impact && <div className="text-xs font-bold text-white bg-black/30 px-3 py-1 rounded border border-white/10">{item.impact}</div>}
                                                          {item.status !== 'Pending' ? (
                                                              <div className={`px-3 py-1 rounded text-xs font-bold border flex items-center gap-2
                                                                  ${item.status === 'Approved' ? 'bg-green-500/20 text-green-400 border-green-500/20' : 
                                                                    item.status === 'Rejected' ? 'bg-red-500/20 text-red-400 border-red-500/20' : 
                                                                    'bg-blue-500/20 text-blue-400 border-blue-500/20'}`}>
                                                                  <Icon name={item.status === 'Approved' ? 'fa-check' : item.status === 'Rejected' ? 'fa-ban' : 'fa-share'} /> {item.status}
                                                              </div>
                                                          ) : (
                                                              <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                                                  <button onClick={() => handleAction(item.id, 'Rejected')} className="p-2 hover:bg-white/10 rounded text-textMuted hover:text-white" title="Reject"><Icon name="fa-xmark"/></button>
                                                                  <button onClick={() => handleAction(item.id, 'Escalated')} className="p-2 hover:bg-blue-500/20 rounded text-textMuted hover:text-blue-400" title="Escalate"><Icon name="fa-share"/></button>
                                                                  <button onClick={() => handleAction(item.id, 'Approved')} className="p-2 hover:bg-green-500/20 rounded text-textMuted hover:text-green-400" title="Approve"><Icon name="fa-check"/></button>
                                                              </div>
                                                          )}
                                                      </div>
                                                  </div>
                                              ))}
                                          </div>
                                      )}

                                      {activeTab === 'items' && decisions.map(d => (
                                          <div 
                                              key={d.id}
                                              ref={(el) => { itemRefs.current[d.id] = el }}
                                              className={`
                                                  flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/5 transition-all group mb-2
                                                  ${highlightedId === d.id ? 'bg-primary/10 border-l-4 border-primary highlight-pulse z-10 relative' : 'hover:border-primary/30'}
                                                  ${d.status !== 'Pending' ? 'opacity-70' : ''}
                                              `}
                                          >
                                              <div className="flex items-center gap-4">
                                                  <div className={`w-10 h-10 flex items-center justify-center bg-${d.color || (d.campaignMeta ? d.campaignMeta.color : 'gray')}-500/20 text-${d.color || (d.campaignMeta ? d.campaignMeta.color : 'gray')}-500 rounded-lg shadow-sm`}><Icon name={d.icon || (d.campaignMeta ? d.campaignMeta.icon : 'fa-circle')} /></div>
                                                  <div>
                                                      <div className="font-bold text-sm text-white flex items-center gap-2">
                                                          <span className={d.status !== 'Pending' ? 'line-through decoration-white/20 text-textMuted' : ''}>{d.title}</span>
                                                          {d.campaignId && <span className="text-[9px] bg-purple-500/20 text-purple-400 border border-purple-500/30 px-1.5 py-0.5 rounded">CAMP</span>}
                                                      </div>
                                                      <div className="text-xs text-textMuted mt-0.5"><span className="text-primary font-bold mr-1">{d.requester}:</span>{d.desc}</div>
                                                  </div>
                                              </div>
                                              <div className="flex items-center gap-4">
                                                  {d.impact && <div className="text-xs font-bold text-white bg-black/30 px-3 py-1 rounded border border-white/10">{d.impact}</div>}
                                                  {d.status !== 'Pending' ? (
                                                      <div className={`px-3 py-1 rounded text-xs font-bold border flex items-center gap-2
                                                          ${d.status === 'Approved' ? 'bg-green-500/20 text-green-400 border-green-500/20' : 
                                                            d.status === 'Rejected' ? 'bg-red-500/20 text-red-400 border-red-500/20' : 
                                                            'bg-blue-500/20 text-blue-400 border-blue-500/20'}`}>
                                                          <Icon name={d.status === 'Approved' ? 'fa-check' : d.status === 'Rejected' ? 'fa-ban' : 'fa-share'} /> {d.status}
                                                      </div>
                                                  ) : (
                                                      <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                                          <button onClick={() => handleAction(d.id, 'Rejected')} className="p-2 hover:bg-white/10 rounded text-textMuted hover:text-white" title="Reject"><Icon name="fa-xmark"/></button>
                                                          <button onClick={() => handleAction(d.id, 'Escalated')} className="p-2 hover:bg-blue-500/20 rounded text-textMuted hover:text-blue-400" title="Escalate"><Icon name="fa-share"/></button>
                                                          <button onClick={() => handleAction(d.id, 'Approved')} className="p-2 hover:bg-green-500/20 rounded text-textMuted hover:text-green-400" title="Approve"><Icon name="fa-check"/></button>
                                                      </div>
                                                  )}
                                              </div>
                                          </div>
                                      ))}
                                  </div>
                              )}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      // --- BUSINESS DASHBOARD COMPONENTS ---
      const BUSINESS_REGION_DATA = {
          Global: {
              kpi: {
                  protected: '$4.2M', protectedTrend: '12%',
                  fraud: '$12.5k', 
                  loss: '$850', lossSub: '-2.1%', 
                  vipRisk: '12', vipSub: 'Caught in security filters'
              },
              lifecycle: [
                  { stage: 'Onboarding', secScore: 12, secTrend: 'stable', successRate: 92, cost: '$1.2k', status: 'good' },
                  { stage: 'Access', secScore: 92, secTrend: 'critical', successRate: 88, cost: '$45k', status: 'warning' },
                  { stage: 'Transaction', secScore: 45, secTrend: 'warning', successRate: 95, cost: '$12k', status: 'good' },
                  { stage: 'Profile', secScore: 8, secTrend: 'stable', successRate: 99, cost: '$0', status: 'good' },
              ]
          },
          APAC: {
              kpi: {
                  protected: '$2.8M', protectedTrend: '18%',
                  fraud: '$11.2k',
                  loss: '$320', lossSub: '-4.5%',
                  vipRisk: '8', vipSub: 'Caught in security filters'
              },
              lifecycle: [
                  { stage: 'Onboarding', secScore: 15, secTrend: 'up', successRate: 90, cost: '$800', status: 'good' },
                  { stage: 'Access', secScore: 96, secTrend: 'critical', successRate: 82, cost: '$38k', status: 'critical' },
                  { stage: 'Transaction', secScore: 55, secTrend: 'up', successRate: 91, cost: '$8k', status: 'warning' },
                  { stage: 'Profile', secScore: 5, secTrend: 'down', successRate: 99, cost: '$0', status: 'good' },
              ]
          },
          EMEA: {
              kpi: {
                  protected: '$450k', protectedTrend: '2%',
                  fraud: '$1.3k',
                  loss: '$120', lossSub: '-0.5%',
                  vipRisk: '2', vipSub: 'Caught in security filters'
              },
              lifecycle: [
                  { stage: 'Onboarding', secScore: 22, secTrend: 'up', successRate: 85, cost: '$2.1k', status: 'warning' },
                  { stage: 'Access', secScore: 18, secTrend: 'stable', successRate: 98, cost: '$500', status: 'good' },
                  { stage: 'Transaction', secScore: 12, secTrend: 'down', successRate: 99, cost: '$200', status: 'good' },
                  { stage: 'Profile', secScore: 9, secTrend: 'stable', successRate: 99, cost: '$0', status: 'good' },
              ]
          },
          AMER: {
              kpi: {
                  protected: '$900k', protectedTrend: '5%',
                  fraud: '$0',
                  loss: '$410', lossSub: '-0.1%',
                  vipRisk: '1', vipSub: 'Caught in security filters'
              },
              lifecycle: [
                  { stage: 'Onboarding', secScore: 8, secTrend: 'stable', successRate: 98, cost: '$100', status: 'good' },
                  { stage: 'Access', secScore: 12, secTrend: 'stable', successRate: 99, cost: '$0', status: 'good' },
                  { stage: 'Transaction', secScore: 18, secTrend: 'stable', successRate: 99, cost: '$0', status: 'good' },
                  { stage: 'Profile', secScore: 6, secTrend: 'stable', successRate: 99, cost: '$0', status: 'good' },
              ]
          },
          MENA: {
              kpi: {
                  protected: '$50k', protectedTrend: '0%',
                  fraud: '$0',
                  loss: '$0', lossSub: '0%',
                  vipRisk: '0', vipSub: 'Caught in security filters'
              },
              lifecycle: [
                  { stage: 'Onboarding', secScore: 5, secTrend: 'stable', successRate: 99, cost: '0', status: 'good' },
                  { stage: 'Access', secScore: 5, secTrend: 'stable', successRate: 100, cost: '0', status: 'good' },
                  { stage: 'Transaction', secScore: 5, secTrend: 'stable', successRate: 100, cost: '0', status: 'good' },
                  { stage: 'Profile', secScore: 5, secTrend: 'stable', successRate: 100, cost: '0', status: 'good' },
              ]
          }
      };

      const REGION_OPTIONS = [
          { key: 'Global', label: 'Global View' },
          { key: 'AMER', label: 'Americas' },
          { key: 'EMEA', label: 'Europe/ME/Africa' },
          { key: 'APAC', label: 'Asia-Pacific' },
          { key: 'MENA', label: 'Middle East & North Africa' }
      ];

      const BusinessDashboard = ({ onShowModal, onNotify, queue = [], onAction, onNavigate }) => {
        const [activeRegion, setActiveRegion] = useState('Global');
        const currentData = BUSINESS_REGION_DATA[activeRegion] || BUSINESS_REGION_DATA['Global'];
        const filteredQueue = activeRegion === 'Global' 
          ? queue.filter(item => item.status === 'Pending') 
          : queue.filter(item => item.status === 'Pending' && (item.region === activeRegion || item.region === 'Global'));

        const handleQueueNavigate = (id) => {
            if (onNavigate) onNavigate('outreach', id);
        };

        return (
          <div className="space-y-6 animate-fade-in flex flex-col h-full pb-6">
             <div className="flex justify-between items-center bg-surface/30 backdrop-blur-sm border border-white/5 rounded-2xl p-4 shadow-lg shrink-0 relative z-50">
                  <div className="flex items-center gap-3">
                      <div className="w-1 h-6 bg-primary rounded-full shadow-[0_0_10px_rgba(249,115,22,0.5)]"></div>
                      <div>
                          <h2 className="text-xl font-bold text-white tracking-tight">Business Impact Monitor</h2>
                          <p className="text-[10px] text-textMuted uppercase tracking-wider">Correlating Security Strategy with Revenue</p>
                      </div>
                  </div>
                  
                  <div className="relative group/dropdown">
                      <div className="flex items-center gap-2 bg-black/40 border border-white/10 px-3 py-1.5 rounded-lg hover:border-white/30 transition-all cursor-pointer">
                          <Icon name="fa-globe" className="text-textMuted text-xs" />
                          <span className="text-sm font-bold text-white min-w-[60px] text-center">{activeRegion}</span>
                          <Icon name="fa-chevron-down" className="text-[10px] text-textMuted" />
                      </div>
                      <div className="absolute right-0 top-full mt-2 w-48 bg-[#18181b] border border-white/10 rounded-xl shadow-2xl overflow-hidden opacity-0 invisible group-hover/dropdown:opacity-100 group-hover/dropdown:visible transition-all duration-200 transform origin-top-right">
                          {REGION_OPTIONS.map((opt) => (
                              <div 
                                  key={opt.key} 
                                  onClick={() => setActiveRegion(opt.key)}
                                  className={`p-3 hover:bg-white/5 cursor-pointer border-b border-white/5 last:border-0 ${activeRegion === opt.key ? 'bg-primary/10' : ''}`}
                              >
                                  <div className={`text-xs font-bold ${activeRegion === opt.key ? 'text-primary' : 'text-white'}`}>{opt.key}</div>
                                  <div className="text-[10px] text-textMuted">{opt.label}</div>
                              </div>
                          ))}
                      </div>
                  </div>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 min-h-[160px] shrink-0 relative z-0">
                <StatCard 
                  title="REVENUE PROTECTED" 
                  value={currentData.kpi.protected}
                  subtext={` ${currentData.kpi.protectedTrend} From active threats`} 
                  trend="" 
                  trendUp={true} 
                  icon="fa-shield-halved" 
                  color="text-green-500 bg-green-500/10 border-green-500/20" 
                />
                <StatCard 
                  title="NET FRAUD IMPACT" 
                  value={currentData.kpi.fraud}
                  subtext="Actual leakage to profit" 
                  trend=""
                  trendUp={false} 
                  icon="fa-money-bill-wave" 
                  color="text-red-500 bg-red-500/10 border-red-500/20" 
                />
                <StatCard 
                  title="CONVERSION LOSS" 
                  value={currentData.kpi.loss}
                  subtext={`${currentData.kpi.lossSub} Friction Drop-off`} 
                  trend=""
                  trendUp={false} 
                  icon="fa-arrow-trend-down" 
                  color="text-orange-500 bg-orange-500/10 border-orange-500/20" 
                />
                <StatCard 
                  title="VIPs AT RISK" 
                  value={currentData.kpi.vipRisk}
                  subtext={currentData.kpi.vipSub} 
                  trend="" 
                  trendUp={false} 
                  icon="fa-crown" 
                  color="text-yellow-500 bg-yellow-500/10 border-yellow-500/20" 
                />
             </div>

             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0 relative z-0 pb-8">
                
                <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-6 shadow-lg flex flex-col h-full overflow-visible">
                   <div className="flex items-center justify-between mb-4">
                       <h2 className="text-lg font-bold text-white flex items-center gap-2">
                          <div className="w-1 h-5 bg-primary rounded-full shadow-[0_0_10px_rgba(249,115,22,0.5)]"></div>
                          Lifecycle Casualty Matrix
                       </h2>
                       
                       <div className="relative group/tooltip z-[100]">
                          <Icon name="fa-circle-info" className="text-textMuted hover:text-primary cursor-help text-sm" />
                          <div className="absolute right-0 top-6 w-72 bg-[#18181b] border border-white/20 p-4 rounded-xl shadow-2xl opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none z-[100]">
                              <div className="text-[10px] font-bold text-white mb-3 border-b border-white/10 pb-2 flex items-center gap-2">
                                  <Icon name="fa-scale-balanced" className="text-primary"/> Data Correlation Logic
                              </div>
                              <div className="space-y-4">
                                  <div>
                                      <div className="flex justify-between items-center mb-1">
                                          <span className="text-[9px] text-green-400 uppercase font-bold">Security Pressure</span>
                                          <span className="text-[8px] text-textMuted border border-white/10 px-1 rounded">Source: Risk Monitor</span>
                                      </div>
                                      <p className="text-[10px] text-gray-400 leading-relaxed">
                                          Directly linked to the <span className="text-white">Lifecycle Risk Score</span>. Higher pressure indicates the security engine is applying stricter scrutiny (Score 80+).
                                      </p>
                                  </div>
                                  <div>
                                      <div className="flex justify-between items-center mb-1">
                                          <span className="text-[9px] text-blue-400 uppercase font-bold">Success Rate</span>
                                          <span className="text-[8px] text-textMuted border border-white/10 px-1 rounded">Source: Pass Rate</span>
                                      </div>
                                      <p className="text-[10px] text-gray-400 leading-relaxed">
                                          The percentage of good customers passing <span className="text-white">without intervention</span> (Auto-Safe). A higher rate means seamless business flow.
                                      </p>
                                  </div>
                                  <div>
                                      <div className="flex justify-between items-center mb-1">
                                          <span className="text-[9px] text-orange-400 uppercase font-bold">Friction Cost</span>
                                          <span className="text-[8px] text-textMuted border border-white/10 px-1 rounded">Source: Challenge Rate</span>
                                      </div>
                                      <p className="text-[10px] text-gray-400 leading-relaxed">
                                          Financial loss from churn caused by <span className="text-white">Heavy Challenges</span> (e.g., Bio/SMS). More challenges = Higher friction cost.
                                      </p>
                                  </div>
                              </div>
                          </div>
                       </div>
                   </div>
                   
                   <div className="mt-2">
                      {/* FIX 1: Compact Table Layout */}
                      <table className="w-full text-left text-[10px] border-separate border-spacing-y-1">
                          <thead className="text-[10px] text-textMuted uppercase tracking-wider">
                              <tr>
                                  <th className="px-3 pb-2">Business Stage</th>
                                  <th className="px-3 pb-2">Security Pressure</th>
                                  <th className="px-3 pb-2">Success Rate</th>
                                  <th className="px-3 pb-2 text-right">Friction Cost</th>
                              </tr>
                          </thead>
                          <tbody>
                              {currentData.lifecycle.map((row, i) => (
                                  <tr key={i} className="group hover:bg-white/5 transition-all">
                                      <td className="p-1.5 bg-white/5 rounded-l-lg border-y border-l border-white/5 group-hover:border-white/10">
                                          <div className="font-bold text-white text-[10px] uppercase tracking-wide flex items-center gap-2">
                                              <div className={`w-1.5 h-1.5 rounded-full ${row.status === 'critical' ? 'bg-red-500' : row.status === 'warning' ? 'bg-orange-500' : 'bg-green-500'}`}></div>
                                              {row.stage}
                                          </div>
                                      </td>
                                      <td className="p-1.5 bg-white/5 border-y border-white/5 group-hover:border-white/10">
                                          <div className="flex items-center gap-2">
                                              <div className="flex flex-col w-full max-w-[80px]">
                                                  <div className="flex justify-between text-[9px] mb-0.5">
                                                      <span className="text-textMuted">Risk</span>
                                                      <span className={`font-mono font-bold ${row.secScore > 80 ? 'text-red-500' : row.secScore > 40 ? 'text-orange-400' : 'text-green-400'}`}>
                                                          {row.secScore}/100
                                                      </span>
                                                  </div>
                                                  <div className="h-1 bg-black/50 rounded-full overflow-hidden">
                                                      <div style={{width: `${row.secScore}%`}} className={`h-full rounded-full ${row.secScore > 80 ? 'bg-red-500' : row.secScore > 40 ? 'bg-orange-500' : 'bg-green-500'}`}></div>
                                                  </div>
                                              </div>
                                              {row.secTrend === 'critical' && <Icon name="fa-arrow-trend-up" className="text-[10px] text-red-500 animate-pulse" />}
                                          </div>
                                      </td>
                                      <td className="p-1.5 bg-white/5 border-y border-white/5 group-hover:border-white/10">
                                          <div className="flex items-center gap-3">
                                              <span className={`text-[10px] font-bold ${row.successRate < 90 ? 'text-orange-400' : 'text-white'}`}>
                                                  {row.successRate}%
                                              </span>
                                              <div className="flex-1 h-1.5 bg-black/50 rounded-full overflow-hidden border border-white/5 max-w-[60px]">
                                                  <div style={{width: `${row.successRate}%`}} className={`h-full rounded-full ${row.successRate < 90 ? 'bg-orange-500' : 'bg-green-500'}`}></div>
                                              </div>
                                          </div>
                                      </td>
                                      <td className="p-1.5 bg-white/5 rounded-r-lg border-y border-r border-white/5 group-hover:border-white/10 text-right">
                                          <span className={`text-[10px] font-mono font-bold ${row.status === 'critical' || row.status === 'warning' ? 'text-red-400' : 'text-textMuted'}`}>
                                              {row.cost}
                                          </span>
                                      </td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                   </div>
                </div>

                <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl p-6 shadow-lg flex flex-col h-full">
                   <div className="flex justify-between items-center mb-4">
                       <div className="flex items-center gap-3">
                          <SectionHeader title="Campaign Fallout Queue" tooltip="Customer issues triggered specifically by active Security Campaigns." />
                       </div>
                       <button 
                          onClick={() => handleQueueNavigate(filteredQueue[0]?.id)}
                          className="text-[10px] bg-primary/10 text-primary border border-primary/20 px-3 py-1.5 rounded-lg hover:bg-primary hover:text-black transition-all shadow-[0_0_10px_rgba(249,115,22,0.1)] flex items-center gap-2"
                       >
                          <Icon name="fa-filter" /> View Full Queue
                       </button>
                   </div>
                   
                   <div className="space-y-3">
                      {filteredQueue.length === 0 ? (
                          <div className="flex flex-col items-center justify-center py-10 text-textMuted opacity-50">
                              <Icon name="fa-check-circle" className="text-3xl mb-2 text-green-500/50" />
                              <span className="text-xs">No active fallout for review.</span>
                          </div>
                      ) : (
                          filteredQueue.slice(0, 3).map((item) => (
                          <div 
                              key={item.id} 
                              onClick={() => handleQueueNavigate(item.id)}
                              className="flex flex-col gap-2 p-4 rounded-xl border border-white/5 hover:border-primary/50 hover:bg-white/10 transition-all bg-white/5 group relative overflow-hidden cursor-pointer"
                          >
                              <div className="absolute left-0 top-0 bottom-0 w-1 bg-red-500/50 group-hover:bg-primary transition-colors"></div>
                              <div className="flex justify-between items-start pl-2">
                                  <div className="flex items-center gap-3">
                                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${item.type === 'VIP' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                          <Icon name={item.type === 'VIP' ? 'fa-crown' : 'fa-building'} />
                                      </div>
                                      <div>
                                          <div className="font-bold text-sm text-white flex items-center gap-2 group-hover:text-primary transition-colors">
                                              {item.user}
                                              {item.type === 'VIP' && <span className="text-[9px] bg-yellow-500/20 text-yellow-400 border border-yellow-500/20 px-1.5 rounded font-bold uppercase">VIP</span>}
                                          </div>
                                          <div className="text-[10px] text-textMuted font-mono">{item.time}</div>
                                      </div>
                                  </div>
                                  {item.val !== 'N/A' && (
                                      <div className="text-right">
                                          <div className="text-xs text-textMuted uppercase tracking-widest">Value</div>
                                          <div className="font-mono font-bold text-white">{item.val}</div>
                                      </div>
                                  )}
                              </div>
                              <div className="pl-2 mt-1 py-2 border-t border-white/5 border-dashed">
                                  <div className="flex items-center gap-2 text-xs">
                                      <span className="text-red-400 font-bold"><Icon name="fa-ban" /> Blocked By:</span>
                                      <span className="text-white bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20 truncate max-w-[150px]">{item.campaign}</span>
                                  </div>
                                  <div className="text-[10px] text-textMuted mt-1 ml-5 flex justify-between items-center">
                                      <span>Rule Trigger: <span className="italic text-gray-400">{item.rule}</span></span>
                                      <Icon name="fa-arrow-right" className="text-textMuted opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-1" />
                                  </div>
                              </div>
                          </div>
                          ))
                      )}
                   </div>
                </div>
             </div>
          </div>
        );
      };

      const BusinessOutreachView = ({ queue, onAction, onNotify, highlightedId }) => {
          const [selectedId, setSelectedId] = useState(null);
          const [selectedTemplate, setSelectedTemplate] = useState('apology');
          const itemRefs = useRef({});

          const selectedItem = queue.find(i => i.id === selectedId);
          
          const sortedQueue = [...queue].sort((a, b) => {
              if (a.status === 'Pending' && b.status !== 'Pending') return -1;
              if (a.status !== 'Pending' && b.status === 'Pending') return 1;
              return 0;
          });

          useEffect(() => {
              if (highlightedId) {
                  setSelectedId(highlightedId);
                  setTimeout(() => {
                      const el = itemRefs.current[highlightedId];
                      if (el) {
                          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      }
                  }, 100);
              }
          }, [highlightedId]);

          const handleActionClick = (type) => {
              if (!selectedId) return;
              onAction(selectedId, type, type === 'Notified' ? `Template: ${selectedTemplate}` : 'Manual Override');
              if (onNotify) {
                  onNotify(type === 'Overridden' ? 'Customer successfully unblocked.' : 'Notification sent to customer.');
              }
          };

          return (
              <div className="flex h-full gap-6 animate-fade-in pb-4">
                  <style dangerouslySetInnerHTML={{__html: `
                      @keyframes shadow-pulse {
                          0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); border-color: rgba(249, 115, 22, 0.8); }
                          70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); border-color: rgba(249, 115, 22, 0.4); }
                          100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); border-color: rgba(249, 115, 22, 0.8); }
                      }
                      .highlight-pulse {
                          animation: shadow-pulse 2s infinite;
                      }
                  `}} />
                  
                  <div className="w-1/3 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl shadow-lg flex flex-col overflow-hidden">
                      <div className="p-4 border-b border-white/5 bg-white/5">
                          <h2 className="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                              <Icon name="fa-users-slash" /> Fallout Queue
                          </h2>
                          <div className="text-[10px] text-textMuted mt-1">Customers blocked by security campaigns.</div>
                      </div>
                      <div className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                          {sortedQueue.map(item => (
                              <div 
                                  key={item.id} 
                                  ref={(el) => { itemRefs.current[item.id] = el }}
                                  onClick={() => setSelectedId(item.id)}
                                  className={`p-3 rounded-lg border transition-all cursor-pointer relative group
                                      ${selectedId === item.id 
                                          ? 'bg-primary/10 border-primary shadow-[inset_4px_0_0_0_#f97316]' 
                                          : 'bg-white/5 border-white/5 hover:bg-white/10 hover:border-white/10'
                                      }
                                      ${highlightedId === item.id ? 'highlight-pulse' : ''}
                                      ${item.status !== 'Pending' ? 'opacity-50 grayscale-[0.5]' : ''}
                                  `}
                              >
                                  <div className="flex justify-between items-start mb-1">
                                      <div className="font-bold text-xs text-white group-hover:text-primary transition-colors">{item.user}</div>
                                      <div className="text-[9px] text-textMuted">{item.time}</div>
                                  </div>
                                  <div className="flex items-center gap-2 mb-2">
                                      <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold uppercase ${item.type === 'VIP' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-blue-500/20 text-blue-400'}`}>{item.type}</span>
                                      <span className="text-[9px] text-textMuted truncate max-w-[120px]">{item.campaign}</span>
                                  </div>
                                  <div className="flex justify-between items-end border-t border-white/5 pt-2">
                                      <div className="text-[10px] text-red-400 font-medium truncate pr-2">{item.rule}</div>
                                      <div className={`text-[9px] px-2 py-0.5 rounded border uppercase font-bold ${
                                          item.status === 'Pending' ? 'bg-red-500/10 text-red-500 border-red-500/20' : 
                                          item.status === 'Overridden' ? 'bg-green-500/10 text-green-500 border-green-500/20' : 
                                          'bg-blue-500/10 text-blue-500 border-blue-500/20'
                                      }`}>
                                          {item.status}
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>

                  <div className="flex-1 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl shadow-lg flex flex-col relative overflow-hidden">
                      {selectedItem ? (
                          <Fragment>
                              <div className="p-6 border-b border-white/5 bg-gradient-to-r from-primary/5 to-transparent">
                                  <div className="flex justify-between items-start">
                                      <div className="flex items-center gap-4">
                                          <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-lg ${selectedItem.type === 'VIP' ? 'bg-yellow-500 text-black' : 'bg-white/10 text-white'}`}>
                                              <Icon name={selectedItem.type === 'VIP' ? 'fa-crown' : 'fa-building'} />
                                          </div>
                                          <div>
                                              <h1 className="text-2xl font-bold text-white">{selectedItem.user}</h1>
                                              <div className="flex gap-3 text-xs mt-1">
                                                  <span className="text-textMuted">ID: <span className="font-mono text-white">CUST-{selectedItem.id}</span></span>
                                                  <span className="text-textMuted">Region: <span className="text-white">{selectedItem.region || 'Global'}</span></span>
                                                  <span className="text-textMuted">Value: <span className="font-mono text-green-400 font-bold">{selectedItem.val}</span></span>
                                              </div>
                                          </div>
                                      </div>
                                      {selectedItem.status !== 'Pending' && (
                                          <div className="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-center">
                                              <div className="text-[9px] text-textMuted uppercase tracking-widest">Current Status</div>
                                              <div className={`text-lg font-bold ${selectedItem.status === 'Overridden' ? 'text-green-500' : 'text-blue-500'}`}>{selectedItem.status}</div>
                                          </div>
                                      )}
                                  </div>
                              </div>

                              <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                                  <div className="mb-8">
                                      <h3 className="text-xs font-bold text-textMuted uppercase tracking-widest mb-3 border-b border-white/10 pb-1">Intervention Context</h3>
                                      <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-4 flex gap-4">
                                          <div className="text-red-500 text-xl pt-1"><Icon name="fa-ban" /></div>
                                          <div>
                                              <div className="text-white font-bold mb-1">Blocked by Security Policy</div>
                                              <p className="text-sm text-gray-400 mb-2">
                                                  This customer was flagged by the <span className="text-white font-medium">{selectedItem.campaign}</span> campaign.
                                                  The specific trigger was <span className="font-mono text-red-400 bg-red-500/10 px-1 rounded">{selectedItem.rule}</span>.
                                              </p>
                                              <div className="text-xs text-textMuted italic">
                                                  "High velocity transactions detected from recognized botnet subnet."
                                              </div>
                                          </div>
                                      </div>
                                  </div>

                                  {selectedItem.status === 'Pending' ? (
                                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                          <div className="bg-white/5 border border-white/5 rounded-xl p-5 hover:border-green-500/30 transition-all group">
                                              <div className="flex justify-between mb-4">
                                                  <div className="w-10 h-10 rounded-lg bg-green-500/20 text-green-500 flex items-center justify-center text-xl">
                                                      <Icon name="fa-unlock" />
                                                  </div>
                                                  <span className="text-[10px] text-green-500 font-bold uppercase border border-green-500/20 px-2 py-1 rounded bg-green-500/10 h-fit">Risk Acceptance</span>
                                              </div>
                                              <h4 className="text-white font-bold mb-2">One-Time Override</h4>
                                              <p className="text-xs text-textMuted mb-4 min-h-[40px]">
                                                  Temporarily whitelist this customer for 24 hours to allow transaction completion. 
                                                  <span className="block mt-1 text-orange-400 text-[10px]">* Logs incident as "Biz Accepted Risk"</span>
                                              </p>
                                              <button onClick={() => handleActionClick('Overridden')} className="w-full py-2.5 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold text-sm shadow-lg transition-all">
                                                  Approve Override
                                              </button>
                                          </div>

                                          <div className="bg-white/5 border border-white/5 rounded-xl p-5 hover:border-blue-500/30 transition-all group">
                                              <div className="flex justify-between mb-4">
                                                  <div className="w-10 h-10 rounded-lg bg-blue-500/20 text-blue-500 flex items-center justify-center text-xl">
                                                      <Icon name="fa-envelope" />
                                                  </div>
                                                  <span className="text-[10px] text-blue-500 font-bold uppercase border border-blue-500/20 px-2 py-1 rounded bg-blue-500/10 h-fit">Communication</span>
                                              </div>
                                              <h4 className="text-white font-bold mb-2">Notify Customer</h4>
                                              
                                              <select 
                                                  className="w-full bg-black/40 border border-white/20 rounded p-2 text-xs text-white mb-4 focus:border-blue-500 outline-none"
                                                  value={selectedTemplate}
                                                  onChange={(e) => setSelectedTemplate(e.target.value)}
                                              >
                                                  <option value="apology">Template: Security Block Apology</option>
                                                  <option value="verify">Template: Identity Verification Req</option>
                                                  <option value="travel">Template: Travel Status Confirmation</option>
                                              </select>

                                              <button onClick={() => handleActionClick('Notified')} className="w-full py-2.5 rounded-lg bg-white/10 hover:bg-white/20 text-white font-bold text-sm border border-white/10 transition-all">
                                                  Send Notification
                                              </button>
                                          </div>
                                      </div>
                                  ) : (
                                      <div className="p-8 border border-white/5 rounded-xl bg-white/5 flex flex-col items-center justify-center text-center">
                                          <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl mb-4 ${selectedItem.status === 'Overridden' ? 'bg-green-500/20 text-green-500' : 'bg-blue-500/20 text-blue-500'}`}>
                                              <Icon name={selectedItem.status === 'Overridden' ? 'fa-unlock' : 'fa-paper-plane'} />
                                          </div>
                                          <h3 className="text-xl font-bold text-white mb-1">Action Completed</h3>
                                          <p className="text-textMuted text-sm">
                                              This item was marked as <span className="font-bold text-white">{selectedItem.status}</span>.
                                          </p>
                                          <div className="text-[10px] text-textMuted mt-4 opacity-50">Log ID: LOG-{Date.now().toString().slice(-6)}</div>
                                      </div>
                                  )}
                              </div>
                          </Fragment>
                      ) : (
                          <div className="flex flex-col items-center justify-center h-full text-textMuted opacity-50">
                              <Icon name="fa-hand-pointer" className="text-4xl mb-4" />
                              <p className="text-sm">Select an item from the queue to view details and take action.</p>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      // --- EXECUTIVE DASHBOARD COMPONENTS ---
      const EXECUTIVE_REGION_DATA = {
          Global: {
              kpi: {
                  riskLevel: 'CRITICAL',
                  riskScore: 85,
                  netValue: '$4.18M',
                  valueTrend: '+11.5%',
                  cxScore: '92.4',
                  cxTrend: '-2.1% Friction',
                  activeThreats: 2,
                  compliance: { score: 100, label: 'PCI-DSS' }
              },
              scenario: {
                  title: 'Active Attack: Credential Stuffing & Synthetic Loans',
                  containment: 85,
                  impact: 'Global Operations',
                  estLoss: 12500,
                  estLossStr: '$12.5k',
                  totalProtected: 4200000,
                  status: 'Mitigating'
              }
          },
          APAC: {
              kpi: {
                  riskLevel: 'CRITICAL',
                  riskScore: 92,
                  netValue: '$2.78M',
                  valueTrend: '+18%',
                  cxScore: '88.5',
                  cxTrend: '-4.5% Friction',
                  activeThreats: 1,
                  compliance: { score: 98, label: 'MAS TRM' }
              },
              scenario: {
                  title: 'Active Attack: Botnet Source detected in East Asia',
                  containment: 60,
                  impact: 'Payment Gateway',
                  estLoss: 11200,
                  estLossStr: '$11.2k',
                  totalProtected: 2800000,
                  status: 'Escalated'
              }
          },
          EMEA: {
              kpi: {
                  riskLevel: 'ELEVATED',
                  riskScore: 65,
                  netValue: '$448k',
                  valueTrend: '+2%',
                  cxScore: '96.2',
                  cxTrend: '-0.5% Friction',
                  activeThreats: 1,
                  compliance: { score: 100, label: 'GDPR' }
              },
              scenario: {
                  title: 'Watchlist: Cross-border Money Mule Activity',
                  containment: 95,
                  impact: 'Compliance',
                  estLoss: 1300,
                  estLossStr: '$1.3k',
                  totalProtected: 450000,
                  status: 'Monitoring'
              }
          },
          AMER: {
              kpi: {
                  riskLevel: 'NORMAL',
                  riskScore: 25,
                  netValue: '$900k',
                  valueTrend: '+5%',
                  cxScore: '98.5',
                  cxTrend: '-0.1% Friction',
                  activeThreats: 0,
                  compliance: { score: 100, label: 'SOC2' }
              },
              scenario: {
                  title: 'Routine: Seasonal Shopping Traffic Spike',
                  containment: 100,
                  impact: 'Infrastructure',
                  estLoss: 0,
                  estLossStr: '$0',
                  totalProtected: 900000,
                  status: 'Stable'
              }
          },
          MENA: {
              kpi: {
                  riskLevel: 'NORMAL',
                  riskScore: 15,
                  netValue: '$50k',
                  valueTrend: '0%',
                  cxScore: '99.0',
                  cxTrend: '0% Friction',
                  activeThreats: 0,
                  compliance: { score: 100, label: 'Local Reg' }
              },
              scenario: {
                  title: 'Routine: Standard Operations',
                  containment: 100,
                  impact: 'None',
                  estLoss: 0,
                  estLossStr: '$0',
                  totalProtected: 50000,
                  status: 'Stable'
              }
          }
      };

      const ExecutiveDashboard = ({ governanceItems, onNavigate }) => {
        const [activeRegion, setActiveRegion] = useState('Global');
        const currentData = EXECUTIVE_REGION_DATA[activeRegion] || EXECUTIVE_REGION_DATA['Global'];
        const isCritical = currentData.kpi.riskLevel === 'CRITICAL';
        
        const pendingCount = governanceItems.filter(i => i.status === 'Pending').length;
        const budgetCount = governanceItems.filter(i => i.status === 'Pending' && i.type === 'financial').length;
        const strategyCount = governanceItems.filter(i => i.status === 'Pending' && i.type === 'strategic').length;
        const complianceCount = governanceItems.filter(i => i.status === 'Pending' && i.type === 'compliance').length;

        return (
          <div className="space-y-8 animate-fade-in pb-6 flex flex-col h-full">
             <div className="flex justify-between items-center bg-surface/30 backdrop-blur-sm border border-white/5 rounded-2xl p-4 shadow-lg shrink-0 relative z-50">
                  <div className="flex items-center gap-3">
                      <div className="w-1 h-6 bg-red-500 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                      <div>
                          <h2 className="text-xl font-bold text-white tracking-tight">Executive Command</h2>
                          <p className="text-[10px] text-textMuted uppercase tracking-wider">Macro-Level Security & Business Health</p>
                      </div>
                  </div>
                  
                  <div className="relative group/dropdown">
                      <div className="flex items-center gap-2 bg-black/40 border border-white/10 px-3 py-1.5 rounded-lg hover:border-white/30 transition-all cursor-pointer">
                          <Icon name="fa-globe" className="text-textMuted text-xs" />
                          <span className="text-sm font-bold text-white min-w-[60px] text-center">{activeRegion}</span>
                          <Icon name="fa-chevron-down" className="text-[10px] text-textMuted" />
                      </div>
                      <div className="absolute right-0 top-full mt-2 w-48 bg-[#18181b] border border-white/10 rounded-xl shadow-2xl overflow-hidden opacity-0 invisible group-hover/dropdown:opacity-100 group-hover/dropdown:visible transition-all duration-200 transform origin-top-right">
                          {REGION_OPTIONS.map((opt) => (
                              <div 
                                  key={opt.key} 
                                  onClick={() => setActiveRegion(opt.key)}
                                  className={`p-3 hover:bg-white/5 cursor-pointer border-b border-white/5 last:border-0 ${activeRegion === opt.key ? 'bg-primary/10' : ''}`}
                              >
                                  <div className={`text-xs font-bold ${activeRegion === opt.key ? 'text-primary' : 'text-white'}`}>{opt.key}</div>
                                  <div className="text-[10px] text-textMuted">{opt.label}</div>
                              </div>
                          ))}
                      </div>
                  </div>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className={`p-5 rounded-2xl border flex flex-col justify-between relative overflow-hidden group transition-all ${isCritical ? 'bg-red-900/10 border-red-500/30' : 'bg-surface/60 border-white/5'}`}>
                    <div className="flex justify-between items-start z-10">
                        <div>
                            <div className="text-[10px] text-textMuted uppercase tracking-widest font-bold mb-1">Security Posture</div>
                            <div className={`text-2xl font-bold ${isCritical ? 'text-red-500' : 'text-green-500'}`}>{currentData.kpi.riskLevel}</div>
                        </div>
                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-lg ${isCritical ? 'bg-red-500/20 text-red-500' : 'bg-green-500/20 text-green-500'}`}>
                            <Icon name="fa-shield-heart" />
                        </div>
                    </div>
                    <div className="mt-4 z-10">
                        <div className="flex justify-between text-xs mb-1">
                            <span className="text-textMuted">Threat Intensity</span>
                            <span className="text-white font-mono">{currentData.kpi.riskScore}/100</span>
                        </div>
                        <div className="w-full h-1 bg-black/40 rounded-full overflow-hidden">
                            <div style={{width: `${currentData.kpi.riskScore}%`}} className={`h-full rounded-full ${isCritical ? 'bg-red-500' : 'bg-green-500'}`}></div>
                        </div>
                    </div>
                </div>

                <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-2xl p-5 flex flex-col justify-between relative overflow-hidden hover:border-green-500/30 transition-all group">
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-[10px] text-textMuted uppercase tracking-widest font-bold mb-1">Net Value Preserved</div>
                            <div className="text-2xl font-bold text-white tracking-tight">{currentData.kpi.netValue}</div>
                        </div>
                        <div className="w-8 h-8 rounded-lg bg-green-500/20 text-green-500 flex items-center justify-center text-lg">
                            <Icon name="fa-coins" />
                        </div>
                    </div>
                    <div className="mt-4">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="px-1.5 py-0.5 rounded bg-green-500/10 text-green-500 text-[10px] font-bold border border-green-500/20">{currentData.kpi.valueTrend}</span>
                          <span className="text-[10px] text-textMuted">vs last period</span>
                        </div>
                        <div className="pt-2 border-t border-white/5 flex justify-between items-center text-[9px] text-textMuted">
                            <span>Target (Monthly)</span>
                            <span className="text-white font-mono">$4.0M</span>
                        </div>
                    </div>
                </div>

                <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-2xl p-5 flex flex-col justify-between relative overflow-hidden hover:border-blue-500/30 transition-all group">
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-[10px] text-textMuted uppercase tracking-widest font-bold mb-1">Customer Experience</div>
                            <div className="text-2xl font-bold text-white tracking-tight">{currentData.kpi.cxScore} <span className="text-sm font-normal text-textMuted">/ 100</span></div>
                        </div>
                        <div className="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-500 flex items-center justify-center text-lg">
                            <Icon name="fa-users" />
                        </div>
                    </div>
                    <div className="mt-4 flex items-center gap-2">
                        <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border ${currentData.kpi.cxScore < 90 ? 'bg-orange-500/10 text-orange-500 border-orange-500/20' : 'bg-blue-500/10 text-blue-500 border-blue-500/20'}`}>
                            {currentData.kpi.cxTrend}
                        </span>
                        <span className="text-[10px] text-textMuted">Impact from Security</span>
                    </div>
                </div>

                <div className="bg-surface/60 backdrop-blur-md border border-white/5 rounded-2xl p-5 flex flex-col justify-between relative overflow-hidden hover:border-purple-500/30 transition-all group">
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-[10px] text-textMuted uppercase tracking-widest font-bold mb-1">Compliance Status</div>
                            <div className="text-2xl font-bold text-white tracking-tight flex items-center gap-2">
                                {currentData.kpi.compliance.score}%
                                <Icon name="fa-circle-check" className="text-sm text-green-500" />
                            </div>
                        </div>
                        <div className="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-500 flex items-center justify-center text-lg">
                            <Icon name="fa-scale-balanced" />
                        </div>
                    </div>
                    <div className="mt-4 flex items-center gap-2">
                        <span className="px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-400 text-[10px] font-bold border border-purple-500/20">
                            {currentData.kpi.compliance.label}
                        </span>
                        <span className="text-[10px] text-textMuted">Fully Audited</span>
                    </div>
                </div>
             </div>

             <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 min-h-0">
                <div className="flex flex-col gap-4">
                   <SectionHeader title="Active Incident Context" />
                   <div className="bg-gradient-to-br from-surface/80 to-black/40 backdrop-blur-md border border-white/10 rounded-xl p-6 shadow-lg flex-1 relative overflow-hidden">
                      <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-primary to-transparent"></div>
                      
                      <div className="flex items-center gap-4 mb-6">
                          <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-lg ${isCritical ? 'bg-red-500 text-white animate-pulse' : 'bg-white/10 text-textMuted'}`}>
                              <Icon name={isCritical ? 'fa-fire' : 'fa-check'} />
                          </div>
                          <div>
                              <h3 className="text-lg font-bold text-white leading-tight">{currentData.scenario.title}</h3>
                              <div className="flex gap-3 text-xs mt-1 text-textMuted">
                                  <span>Status: <span className="text-white font-bold">{currentData.scenario.status}</span></span>
                                  <span></span>
                                  <span>Scope: <span className="text-white font-bold">{currentData.scenario.impact}</span></span>
                              </div>
                          </div>
                      </div>

                      <div className="space-y-6">
                          <div>
                              <div className="flex justify-between text-xs mb-1 font-bold">
                                  <span className="text-textMuted">Threat Containment</span>
                                  <span className={currentData.scenario.containment < 100 ? "text-orange-400" : "text-green-400"}>{currentData.scenario.containment}%</span>
                              </div>
                              <div className="w-full h-2 bg-black/50 rounded-full overflow-hidden border border-white/5">
                                  <div style={{width: `${currentData.scenario.containment}%`}} className={`h-full rounded-full transition-all duration-1000 ${currentData.scenario.containment < 100 ? 'bg-orange-500' : 'bg-green-500'}`}></div>
                              </div>
                          </div>

                          <div className="p-4 bg-white/5 rounded-xl border border-white/5">
                              <div className="flex justify-between text-[10px] uppercase tracking-widest text-textMuted mb-2">
                                  <span>Efficiency Ratio</span>
                                  <span className="text-white font-bold">99.7% Protected</span>
                              </div>
                              
                              <div className="w-full h-4 bg-black/50 rounded-full overflow-hidden flex mb-2">
                                  <div className="h-full bg-green-600 transition-all" style={{width: '99.7%'}}></div>
                                  <div className="h-full bg-red-500 transition-all" style={{width: '0.3%'}}></div>
                              </div>

                              <div className="flex justify-between text-xs">
                                  <div className="flex items-center gap-2">
                                      <div className="w-2 h-2 rounded-full bg-green-600"></div>
                                      <span className="text-textMuted">Preserved: <span className="text-white font-mono">{currentData.kpi.netValue}</span></span>
                                  </div>
                                  <div className="flex items-center gap-2">
                                      <span className="text-textMuted">Loss: <span className="text-red-400 font-mono">{currentData.scenario.estLossStr}</span></span>
                                      <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                  </div>
                              </div>
                          </div>
                      </div>
                   </div>
                </div>

                <div className="flex flex-col gap-4">
                   <SectionHeader title="Governance & Approvals" />
                   <div className="flex flex-col flex-1 min-h-0">
                      <div 
                          onClick={() => onNavigate('governance', null)}
                          className="flex-1 bg-surface/60 backdrop-blur-md border border-white/10 rounded-xl p-6 shadow-lg relative group cursor-pointer hover:bg-surface/80 hover:border-primary/50 transition-all flex flex-col justify-between"
                      >
                          <div className="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                              <Icon name="fa-gavel" className="text-9xl transform -rotate-12" />
                          </div>

                          <div>
                              <div className="flex items-center gap-3 mb-4">
                                  <div className="w-12 h-12 bg-primary/20 text-primary rounded-xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">
                                      <Icon name="fa-scale-balanced" />
                                  </div>
                                  <div>
                                      <h3 className="text-2xl font-bold text-white group-hover:text-primary transition-colors">Governance Hub</h3>
                                      <p className="text-sm text-textMuted">Action Required on Strategic Items</p>
                                  </div>
                              </div>

                              <div className="space-y-3 mt-6">
                                  <div className="flex justify-between items-center p-3 bg-black/20 rounded-lg border border-white/5">
                                      <span className="text-xs text-textMuted flex items-center gap-2"><Icon name="fa-coins" /> Budget & Resources</span>
                                      <span className="text-xs font-bold text-white bg-white/10 px-2 py-0.5 rounded">{budgetCount} Pending</span>
                                  </div>
                                  <div className="flex justify-between items-center p-3 bg-black/20 rounded-lg border border-white/5">
                                      <span className="text-xs text-textMuted flex items-center gap-2"><Icon name="fa-chess" /> Strategic Risk Override</span>
                                      <span className="text-xs font-bold text-white bg-white/10 px-2 py-0.5 rounded">{strategyCount} Pending</span>
                                  </div>
                                  <div className="flex justify-between items-center p-3 bg-black/20 rounded-lg border border-white/5">
                                      <span className="text-xs text-textMuted flex items-center gap-2"><Icon name="fa-file-signature" /> Compliance Sign-offs</span>
                                      <span className="text-xs font-bold text-white bg-white/10 px-2 py-0.5 rounded">{complianceCount} Pending</span>
                                  </div>
                              </div>
                          </div>

                          <div className="mt-6 flex items-center text-sm font-bold text-primary group-hover:translate-x-2 transition-transform">
                              Go to Governance Center <Icon name="fa-arrow-right" className="ml-2" />
                          </div>
                      </div>
                   </div>
                </div>
             </div>
          </div>
        );
      };

      const ExecutiveGovernanceView = ({ items, onAction, highlightedId }) => {
          const [selectedId, setSelectedId] = useState(null);
          const itemRefs = useRef({});

          useEffect(() => {
              if (highlightedId) {
                  setSelectedId(highlightedId);
                  setTimeout(() => {
                      itemRefs.current[highlightedId]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  }, 200);
              }
          }, [highlightedId]);

          const selectedItem = items.find(i => i.id === selectedId) || items[0];

          const getCategoryIcon = (type) => {
              switch(type) {
                  case 'financial': return 'fa-coins';
                  case 'strategic': return 'fa-chess';
                  case 'compliance': return 'fa-file-signature';
                  default: return 'fa-file';
              }
          };

          const getCategoryColor = (type) => {
              switch(type) {
                  case 'financial': return 'text-green-400 bg-green-500/20';
                  case 'strategic': return 'text-orange-400 bg-orange-500/20';
                  case 'compliance': return 'text-blue-400 bg-blue-500/20';
                  default: return 'text-gray-400 bg-gray-500/20';
              }
          };

          return (
              <div className="flex flex-col h-full gap-6 animate-fade-in pb-2">
                  <div className="flex items-center justify-between shrink-0">
                      <div>
                          <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                              <Icon name="fa-scale-balanced" className="text-primary" />
                              Executive Governance
                          </h1>
                          <p className="text-textMuted text-sm mt-1 ml-9">Strategic Authorization & Compliance Center</p>
                      </div>
                      <div className="bg-black/40 px-4 py-2 rounded-lg border border-white/10 text-xs text-textMuted flex gap-4">
                          <span>Pending: <span className="text-white font-bold">{items.filter(i => i.status === 'Pending').length}</span></span>
                          <span>Approved: <span className="text-green-400 font-bold">{items.filter(i => i.status === 'Approved').length}</span></span>
                      </div>
                  </div>

                  <div className="flex h-full gap-6 overflow-hidden">
                      <div className="w-1/3 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl shadow-lg flex flex-col overflow-hidden">
                          <div className="p-4 bg-white/5 border-b border-white/5">
                              <h2 className="text-xs font-bold text-textMuted uppercase tracking-widest">Decision Queue</h2>
                          </div>
                          <div className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                              {items.map(item => (
                                  <div 
                                      key={item.id}
                                      ref={el => { itemRefs.current[item.id] = el }}
                                      onClick={() => setSelectedId(item.id)}
                                      className={`p-4 rounded-xl border cursor-pointer transition-all relative group
                                          ${(selectedId === item.id || (!selectedId && items[0].id === item.id)) 
                                              ? 'bg-white/10 border-primary/50 shadow-[inset_4px_0_0_0_#f97316]' 
                                              : 'bg-transparent border-white/5 hover:bg-white/5 hover:border-white/10'}
                                          ${item.status !== 'Pending' ? 'opacity-60' : ''}
                                      `}
                                  >
                                      <div className="flex justify-between items-start mb-2">
                                          <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm ${getCategoryColor(item.type)}`}>
                                              <Icon name={getCategoryIcon(item.type)} />
                                          </div>
                                          {item.status !== 'Pending' && (
                                              <span className={`text-[10px] px-2 py-0.5 rounded border font-bold uppercase
                                                  ${item.status === 'Approved' ? 'bg-green-500/10 text-green-500 border-green-500/20' : 'bg-red-500/10 text-red-500 border-red-500/20'}
                                              `}>
                                                  {item.status}
                                              </span>
                                          )}
                                      </div>
                                      <h3 className="text-sm font-bold text-white mb-1 group-hover:text-primary transition-colors">{item.title}</h3>
                                      <div className="text-xs text-textMuted flex justify-between">
                                          <span>Req: {item.requester}</span>
                                          <span>{item.date}</span>
                                      </div>
                                  </div>
                              ))}
                          </div>
                      </div>

                      <div className="flex-1 bg-surface/60 backdrop-blur-md border border-white/5 rounded-xl shadow-lg flex flex-col relative overflow-hidden">
                          {selectedItem ? (
                              <Fragment>
                                  <div className="p-8 border-b border-white/5 bg-gradient-to-r from-primary/5 to-transparent">
                                      <div className="flex items-center gap-4 mb-4">
                                          <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${getCategoryColor(selectedItem.type).replace('bg-', 'border-')}`}>
                                              {selectedItem.type}
                                          </span>
                                          <span className="text-textMuted text-xs">ID: GOV-{selectedItem.id}</span>
                                      </div>
                                      <h2 className="text-3xl font-bold text-white mb-2">{selectedItem.title}</h2>
                                      <p className="text-textMuted text-lg font-light">{selectedItem.desc}</p>
                                  </div>

                                  <div className="flex-1 p-8 overflow-y-auto custom-scrollbar">
                                      <div className="grid grid-cols-2 gap-6 mb-8">
                                          <div className="p-4 bg-white/5 rounded-xl border border-white/5">
                                              <div className="text-xs text-textMuted uppercase tracking-widest mb-1">Impact / Cost</div>
                                              <div className="text-xl font-bold text-white font-mono">{selectedItem.amount || selectedItem.impact || 'N/A'}</div>
                                          </div>
                                          <div className="p-4 bg-white/5 rounded-xl border border-white/5">
                                              <div className="text-xs text-textMuted uppercase tracking-widest mb-1">Context</div>
                                              <div className="text-sm text-white">{selectedItem.context || 'Standard Procedure'}</div>
                                          </div>
                                      </div>

                                      <div className="p-6 bg-black/20 rounded-xl border border-white/5 mb-8">
                                          <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                              <Icon name="fa-list" /> Proposal Details
                                          </h4>
                                          <p className="text-sm text-gray-400 leading-relaxed">
                                              This request requires executive authorization due to its strategic impact or financial threshold. 
                                              Approving this will immediately trigger downstream workflows for the {selectedItem.requester} team.
                                              Please review the attached compliance documentation if applicable.
                                          </p>
                                      </div>
                                  </div>

                                  <div className="p-6 border-t border-white/5 bg-black/20 backdrop-blur-xl z-20 shrink-0">
                                      {selectedItem.status === 'Pending' ? (
                                          <div className="flex gap-4">
                                              <button 
                                                  onClick={() => onAction(selectedItem.id, 'reject')}
                                                  className="flex-1 py-4 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 font-bold transition-all"
                                              >
                                                  Reject Request
                                              </button>
                                              <button 
                                                  onClick={() => onAction(selectedItem.id, 'approve')}
                                                  className="flex-[2] py-4 rounded-xl bg-primary text-black hover:bg-primaryHover font-bold shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-3"
                                              >
                                                  <Icon name="fa-signature" /> Approve & Sign
                                              </button>
                                          </div>
                                      ) : (
                                          <div className="p-4 bg-white/5 rounded-xl border border-white/5 text-center">
                                              <div className={`text-lg font-bold mb-1 ${selectedItem.status === 'Approved' ? 'text-green-500' : 'text-red-500'}`}>
                                                  Request {selectedItem.status}
                                              </div>
                                              <p className="text-textMuted text-xs">No further action required.</p>
                                          </div>
                                      )}
                                  </div>
                              </Fragment>
                          ) : (
                              <div className="flex items-center justify-center h-full text-textMuted">Select an item</div>
                          )}
                      </div>
                  </div>
              </div>
          );
      };

      const RoleSelectionScreen = ({ onSelectRole }) => {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
              <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary rounded-full blur-[180px] opacity-20 animate-pulse-fast"></div>
              <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-600 rounded-full blur-[180px] opacity-20 animate-pulse-fast" style={{animationDelay: '1s'}}></div>
            </div>

            <div className="z-10 text-center mb-16 animate-fade-in-up">
              <div className="inline-flex items-center gap-3 mb-6 px-5 py-2 rounded-full bg-white/5 border border-white/10 backdrop-blur-md shadow-2xl">
                <Icon name="fa-shield-halved" className="text-primary text-lg" />
                <span className="text-sm font-bold tracking-widest uppercase text-textMuted">SafePay v3.0</span>
              </div>
              <h1 className="text-6xl font-bold mb-6 tracking-tight text-white drop-shadow-2xl">Select Your Identity</h1>
              <p className="text-textMuted text-lg max-w-2xl mx-auto leading-relaxed">
                Access the SafePay Fraud Prevention System. Choose your role to view your specific dashboard and decision support tools.
              </p>
            </div>

            <div className="z-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 px-8 max-w-[1400px] w-full animate-fade-in-up" style={{animationDelay: '0.2s'}}>
              {ROLES.filter(r => r.id !== null).map((role) => (
                <button
                  key={role.id}
                  onClick={() => onSelectRole(role.id)}
                  className="group flex flex-col p-8 bg-surface/50 backdrop-blur-xl border border-white/5 rounded-2xl hover:border-primary/50 hover:bg-surface/80 hover:shadow-[0_0_40px_rgba(249,115,22,0.1)] transition-all duration-300 text-left relative overflow-hidden"
                >
                  <div className="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                     <Icon name={role.icon} className="text-9xl transform rotate-12 translate-x-4 -translate-y-4" />
                  </div>
                  
                  <div className="w-14 h-14 rounded-2xl bg-white/5 border border-white/5 flex items-center justify-center mb-8 group-hover:bg-primary group-hover:text-black group-hover:shadow-[0_0_20px_rgba(249,115,22,0.6)] transition-all">
                    <Icon name={role.icon} className="text-2xl text-textMuted group-hover:text-black transition-colors" />
                  </div>
                  
                  <h3 className="text-2xl font-bold mb-2 text-white">{role.title}</h3>
                  <span className="text-primary text-sm font-mono mb-4 block opacity-80">{role.name}</span>
                  <p className="text-textMuted text-sm leading-relaxed group-hover:text-gray-300 transition-colors mb-8">
                    {role.description}
                  </p>
                  
                  <div className="mt-auto pt-6 border-t border-white/5 flex items-center text-sm font-bold text-textMuted group-hover:text-primary transition-colors tracking-wide">
                    ENTER SYSTEM <Icon name="fa-arrow-right" className="ml-2 group-hover:translate-x-1 transition-transform text-xs" />
                  </div>
                </button>
              ))}
            </div>
          </div>
        );
      };

      const App = () => {
        const [currentRole, setCurrentRole] = useState(null);
        const [activeModal, setActiveModal] = useState(null);
        const [toastMsg, setToastMsg] = useState(null);
        const [activeView, setActiveView] = useState('monitoring');
        const [highlightedIncidentId, setHighlightedIncidentId] = useState(null);

        // GLOBAL STATE
        const [incidents, setIncidents] = useState([
          { id: 1, title: 'Credential Stuffing Attack', desc: '5000+ login attempts', time: '2m', type: 'critical', ip: '45.22.10.5', status: 'Open', assignee: null, lastUpdated: '10:02 AM', history: [{ actor: 'System', action: 'Flagged', time: '10:02 AM', detail: 'Velocity rule triggered (5k+ req/min)' }] },
          { id: 2, title: 'Payment API Velocity Spike', desc: 'Unusual transaction volume', time: '10m', type: 'warning', ip: '10.0.5.2', status: 'Open', assignee: null, lastUpdated: '9:55 AM', history: [{ actor: 'System', action: 'Flagged', time: '9:55 AM', detail: 'API Limit Exceeded' }] },
          { id: 6, title: 'Suspicious Loan Pattern', desc: 'Synthetic ID characteristics detected', time: '15m', type: 'alert', ip: 'Multiple', status: 'Open', assignee: null, lastUpdated: '9:50 AM', history: [{ actor: 'System', action: 'Flagged', time: '9:50 AM', detail: 'Identity mismatch detected' }] }, 
          { id: 7, title: 'New Device Login (VIP)', desc: 'Login from new Geo (Paris) for VIP user', time: '18m', type: 'warning', ip: '192.168.1.1', status: 'Open', assignee: null, lastUpdated: '9:48 AM', history: [{ actor: 'System', action: 'Flagged', time: '9:48 AM', detail: 'Geo-velocity anomaly' }] }, 
          { id: 8, title: 'High Value Transfer', desc: 'Transfer > $50k to known beneficiary', time: '22m', type: 'info', ip: '10.0.0.5', status: 'Open', assignee: null, lastUpdated: '9:45 AM', history: [{ actor: 'System', action: 'Flagged', time: '9:45 AM', detail: 'Threshold exceeded' }] }, 
          { id: 4, title: 'Botnet Signature Match', desc: 'User-Agent blacklist match', time: '40m', type: 'info', ip: '89.12.x.x', status: 'Active', assignee: 'System', lastUpdated: '9:30 AM', history: [{ actor: 'System', action: 'Auto-Blocked', time: '9:30 AM', detail: 'Blacklist match' }] },
          { id: 5, title: 'Automated Report', desc: 'Daily vulnerability scan complete', time: '2h', type: 'success', ip: 'Local', status: 'Resolved', assignee: 'System', lastUpdated: '8:00 AM', history: [] },
        ]);

        const [reports, setReports] = useState([
          { id: 'RPT-25-2218', title: 'Q3 Penetration Test Results', date: 'Oct 24, 2025', status: 'Closed' },
          { id: 'RPT-25-2217', title: 'DDoS Mitigation Post-Mortem', date: 'Oct 20, 2025', status: 'Archived' },
          { id: 'RPT-25-2215', title: 'User Access Review - APAC', date: 'Oct 15, 2025', status: 'Closed' },
        ]);

        const [managerDecisions, setManagerDecisions] = useState([
            { id: 201, title: 'Block Subnet 45.22.10.0/24', type: 'ban', requester: 'Andy (Eng)', desc: 'High velocity attack source', impact: 'Save $50k/hr', status: 'Pending', campaignId: 'CAMPAIGN-001', campaignMeta: { title: 'Botnet Mitigation (Subnet 45.22.x)', color: 'purple', icon: 'fa-layer-group', desc: 'Coordinated response to Credential Stuffing.' } },
            { id: 202, title: 'Force Password Reset (5k users)', type: 'action', requester: 'Andy (Eng)', desc: 'Compromised accounts', impact: '0 VIPs affected', status: 'Pending', campaignId: 'CAMPAIGN-001', campaignMeta: { title: 'Botnet Mitigation (Subnet 45.22.x)', color: 'purple', icon: 'fa-layer-group', desc: 'Coordinated response to Credential Stuffing.' } },
            { id: 203, title: 'Approve Report RPT-25-2219', type: 'report', requester: 'System', desc: 'Incident Documentation', impact: 'Compliance Reqd', status: 'Pending', campaignId: 'CAMPAIGN-001', campaignMeta: { title: 'Botnet Mitigation (Subnet 45.22.x)', color: 'purple', icon: 'fa-layer-group', desc: 'Coordinated response to Credential Stuffing.' } },
            { id: 305, title: 'High-Value Foreign Txns (Isolated)', requester: 'Fraud System', desc: 'Transfer > $1M to unknown beneficiary.', type: 'escalate', icon: 'fa-money-bill-transfer', color: 'orange', impact: 'Prevent $1.2M Loss', status: 'Pending', campaignId: null },
        ]);

        const [businessQueue, setBusinessQueue] = useState([
            { id: 442, user: 'VIP Client #442', type: 'VIP', region: 'Global', campaign: 'Botnet Mitigation (Global)', rule: 'Geo-Block: High Risk IP', val: '$50,000', time: '10m ago', status: 'Pending' },
            { id: 882, user: 'Acme Corp', type: 'Biz', region: 'Global', campaign: 'Synthetic ID Purge', rule: 'Doc Verification Fail', val: 'N/A', time: '1h ago', status: 'Pending' },
            { id: 905, user: 'Investor Group A', type: 'VIP', region: 'Global', campaign: 'Botnet Mitigation', rule: 'Velocity Limit', val: '$2.1M', time: '2h ago', status: 'Pending' },
            { id: 906, user: 'John Doe', type: 'Retail', region: 'Global', campaign: 'Synthetic ID Purge', rule: 'Phone Mismatch', val: '$100', time: '3h ago', status: 'Pending' },
            { id: 445, user: 'TechGiant APAC', type: 'Biz', region: 'APAC', campaign: 'Botnet Mitigation (Subnet 45.22.x)', rule: 'Velocity Limit Exceeded', val: '$120,000', time: '5m ago', status: 'Pending' },
            { id: 901, user: 'Sarah Jenks', type: 'Retail', region: 'EMEA', campaign: 'Travel Rule Enforcement', rule: 'New Device Login', val: '$200', time: '2h ago', status: 'Pending' },
        ]);

        const [governanceQueue, setGovernanceQueue] = useState([
            { id: 1001, type: 'financial', title: 'Q4 GPU Cluster Expansion', requester: 'Cindy', amount: '$120k', date: 'Oct 24', status: 'Pending', desc: 'Upgrade for AI Sentinel model training to counter new botnet signatures.', context: 'Critical Infra' },
            { id: 1002, type: 'strategic', title: 'Platinum User Friction Override', requester: 'Ben', impact: '+5% Conversion', date: 'Oct 24', status: 'Pending', desc: 'Accept 0.1% risk increase for Platinum tier during Black Friday promo period.', context: 'Business Growth' },
            { id: 1003, type: 'compliance', title: 'Incident #9921 Closure Report', requester: 'Legal', date: 'Oct 23', status: 'Pending', desc: 'Final sign-off for regulatory filing regarding Synthetic Loan attack analysis.', context: 'Regulatory' },
            { id: 1004, type: 'compliance', title: 'Quarterly PCI-DSS Review', requester: 'Auditor', date: 'Oct 20', status: 'Pending', desc: 'Routine compliance check attestation for Payment Gateway V2.', context: 'Audit' },
        ]);

        const [globalRoleData, setGlobalRoleData] = useState(JSON.parse(JSON.stringify(ROLE_DATA)));

        useEffect(() => {
          if (currentRole === 'security_manager') {
              setActiveView('security_status');
          } else if (currentRole === 'business_manager') {
              setActiveView('business_impact');
          } else if (currentRole === 'executive') {
              setActiveView('overview');
          } else {
              setActiveView('monitoring'); 
          }
          setHighlightedIncidentId(null);
        }, [currentRole]);

        const handleNavigate = (view, incidentId = null) => {
          setActiveView(view);
          if (incidentId) {
              setHighlightedIncidentId(incidentId);
          }
        };

        const handleGoHome = () => {
            setCurrentRole(null);
            // In a real app we might reset state here, but for now we keep state persistent in session
        };

        const handleAddReport = (report) => {
            setReports(prev => [report, ...prev]);
        };

        const sendMessageToRole = (targetRole, msg) => {
          setGlobalRoleData(prev => {
              const newData = { ...prev };
              if (newData[targetRole]) {
                  const newMessage = {
                      id: Date.now() + Math.random(),
                      from: 'System',
                      text: '',
                      time: 'Just now',
                      unread: true,
                      direction: 'inbox',
                      ...msg
                  };
                  newData[targetRole].messages = [newMessage, ...newData[targetRole].messages];
              }
              return newData;
          });
        };

        const addSentMessage = (senderRole, msg) => {
           setGlobalRoleData(prev => {
              const newData = { ...prev };
              if (newData[senderRole]) {
                   const newMessage = {
                      id: Date.now() + Math.random(),
                      from: 'Me',
                      text: '',
                      time: 'Just now',
                      unread: false,
                      direction: 'sent',
                      ...msg
                  };
                  newData[senderRole].messages = [newMessage, ...newData[senderRole].messages];
              }
              return newData;
           });
        };

        const addTaskToRole = (targetRole, todo) => {
          setGlobalRoleData(prev => {
              const newData = { ...prev };
              if (newData[targetRole]) {
                  const newTodo = {
                      id: Date.now() + Math.random(),
                      text: '',
                      done: false,
                      assignedBy: 'System',
                      priority: 'medium',
                      ...todo
                  };
                  newData[targetRole].todos = [newTodo, ...newData[targetRole].todos];
              }
              return newData;
          });
        };

        const handleToggleTodo = (roleId, todoId) => {
            setGlobalRoleData(prev => {
                const newData = { ...prev };
                if (newData[roleId]) {
                    newData[roleId].todos = newData[roleId].todos.map(t => 
                      t.id === todoId ? { ...t, done: !t.done } : t
                    );
                }
                return newData;
            });
        };

        const handleUpdateIncident = (id, updates) => {
          setIncidents(prev => prev.map(item => item.id === id ? { ...item, ...updates } : item));
        };

        const handleEscalation = (decision) => {
          const newDecision = { ...decision, status: 'Pending' };
          setManagerDecisions(prev => [newDecision, ...prev]);
          setToastMsg(`Request sent to Security Manager: ${decision.title}`);
          addSentMessage('engineer', { to: 'Cindy (Manager)', text: `Request: ${decision.title} - ${decision.desc}` });
          sendMessageToRole('security_manager', { from: 'Andy (Eng)', text: `ACTION REQUIRED: ${decision.title}. Please review in dashboard.` });
        };

        const handleProcessDecision = (id, status) => {
          const decision = managerDecisions.find(d => d.id === id);
          if (decision) {
              if (decision.requester && decision.requester.includes('Andy')) {
                  sendMessageToRole('engineer', { 
                      from: 'Cindy (Manager)', 
                      text: `Update: Your request '${decision.title}' has been ${status}.`,
                      priority: status === 'Approved' ? 'high' : 'medium'
                  });
              }
              if (status === 'Approved' && decision.type === 'report') {
                  const newGovItem = {
                      id: Date.now(),
                      type: 'compliance', 
                      title: `Sign-off: ${decision.title}`,
                      requester: 'Cindy', 
                      date: 'Today',
                      status: 'Pending',
                      desc: `Final executive sign-off required for ${decision.title}. Verified by Security Manager.`,
                      context: 'Regulatory'
                  };
                  setGovernanceQueue(prev => [newGovItem, ...prev]);
                  sendMessageToRole('executive', {
                      from: 'Cindy (Manager)',
                      text: `ACTION REQUIRED: Please sign-off on ${decision.title}. Item added to Governance Queue.`,
                      priority: 'high'
                  });
                  setToastMsg(`Report escalated to Executive Governance.`);
              } else {
                  setToastMsg(`Decision ${status} and requester notified.`);
              }
          }
          setManagerDecisions(prev => prev.map(d => d.id === id ? { ...d, status: status } : d));
        };

        const handleBusinessAction = (id, type, note) => {
            const item = businessQueue.find(i => i.id === id);
            if (item && type === 'Overridden') {
                sendMessageToRole('security_manager', {
                    from: 'Ben (Business)',
                    text: `RISK OVERRIDE ALERT: Customer ${item.user} whitelisted by Business. Reason: ${note || 'Manual Override'}.`,
                    priority: 'high'
                });
                addTaskToRole('security_manager', {
                    text: `Review Risk Acceptance: ${item.user}`,
                    priority: 'medium',
                    assignedBy: 'System (Ben)'
                });
            }
            setBusinessQueue(prev => prev.map(item => 
                item.id === id ? { ...item, status: type } : item
            ));
        };

        const handleGovernanceAction = (id, action) => {
            const item = governanceQueue.find(i => i.id === id);
            const status = action === 'approve' ? 'Approved' : 'Rejected';
            if (item) {
                let targetRole = '';
                if (item.requester.includes('Cindy')) targetRole = 'security_manager';
                else if (item.requester.includes('Ben')) targetRole = 'business_manager';
                else if (item.requester === 'Legal' || item.requester === 'Auditor') targetRole = 'security_manager'; 

                if (targetRole) {
                    sendMessageToRole(targetRole, {
                        from: 'Mng (Exec)',
                        text: `Governance Decision: '${item.title}' has been ${status}.`,
                        priority: 'high'
                    });
                }
                setToastMsg(`Governance Item ${status}. Notification sent.`);
            }
            setGovernanceQueue(prev => prev.map(item => 
                item.id === id ? { ...item, status: status } : item
            ));
        };

        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
            switch(e.key) {
              case '1': setCurrentRole('engineer'); break;
              case '2': setCurrentRole('security_manager'); break;
              case '3': setCurrentRole('business_manager'); break;
              case '4': setCurrentRole('executive'); break;
              case 'Escape': handleGoHome(); break;
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, []);

        const handleNewTask = () => {
          setActiveModal({
            title: 'Create System Ticket',
            body: <NewTaskForm onClose={() => setActiveModal(null)} onSuccess={() => setToastMsg('Ticket Created & Assigned Successfully')} />
          });
        };

        const handleSettings = () => {
          setActiveModal({
            title: 'System Settings',
            body: <SettingsPanel onClose={() => setActiveModal(null)} onSuccess={() => setToastMsg('Configuration Saved')} />
          });
        };

        if (!currentRole) {
          return <RoleSelectionScreen onSelectRole={setCurrentRole} />;
        }

        const currentRoleData = globalRoleData[currentRole];

        const renderDashboard = () => {
          switch (currentRole) {
            case 'engineer': 
              if (activeView === 'event_analysis') {
                  return (
                      <EventAnalysisView 
                          incidents={incidents}
                          highlightedId={highlightedIncidentId}
                          onShowModal={setActiveModal}
                          onUpdateIncident={handleUpdateIncident}
                          onEscalate={handleEscalation}
                          onNotify={setToastMsg}
                          onAddTask={(todo) => addTaskToRole('engineer', todo)}
                          onAddSentMessage={(msg) => addSentMessage('engineer', msg)}
                          onSendMessageToRole={sendMessageToRole}
                          onBack={() => handleNavigate('monitoring')}
                          onNavigate={handleNavigate}
                      />
                  );
              }
              if (activeView === 'investigations') {
                  return (
                      <EngineerReportsView 
                          reports={reports}
                          onAddReport={handleAddReport}
                          onNotify={setToastMsg} 
                          onEscalate={handleEscalation} 
                      />
                  );
              }
              return (
                  <EngineerDashboard 
                      onShowModal={setActiveModal} 
                      onNotify={setToastMsg}
                      incidents={incidents}
                      onNavigate={handleNavigate}
                  />
              );
            case 'security_manager': 
              if (activeView === 'decision_hub') {
                  return (
                      <DecisionHubView 
                          decisions={managerDecisions}
                          highlightedId={highlightedIncidentId}
                          onNotify={setToastMsg}
                          onProcessDecision={handleProcessDecision}
                      />
                  );
              }
              return (
                  <ManagerDashboard 
                      onNotify={setToastMsg} 
                      decisions={managerDecisions.filter(d => d.status === 'Pending')} 
                      onNavigate={handleNavigate} 
                  />
              );
            case 'business_manager': 
              if (activeView === 'outreach') {
                  return (
                      <BusinessOutreachView 
                          queue={businessQueue}
                          onAction={handleBusinessAction}
                          onNotify={setToastMsg}
                          highlightedId={highlightedIncidentId}
                      />
                  );
              }
              return (
                  <BusinessDashboard 
                      onShowModal={setActiveModal} 
                      onNotify={setToastMsg} 
                      queue={businessQueue}
                      onAction={handleBusinessAction}
                      onNavigate={handleNavigate}
                  />
              );
            case 'executive': 
              if (activeView === 'governance') {
                  return (
                      <ExecutiveGovernanceView 
                          items={governanceQueue}
                          onAction={handleGovernanceAction}
                          highlightedId={highlightedIncidentId}
                      />
                  );
              }
              return (
                  <ExecutiveDashboard 
                      governanceItems={governanceQueue}
                      onNavigate={handleNavigate}
                  />
              );
            default: return <div>Select Role</div>;
          }
        };

        const getPageTitle = (view) => {
            switch(view) {
                case 'monitoring': return 'Monitoring Dashboard';
                case 'event_analysis': return 'Event Analysis';
                case 'investigations': return 'Investigations & Reports';
                case 'security_status': return 'Security Status';
                case 'decision_hub': return 'Decision Governance Hub';
                case 'business_impact': return 'Business Impact';
                case 'outreach': return 'Outreach';
                case 'overview': return 'Executive Overview';
                case 'governance': return 'Governance Center';
                default: return 'Dashboard';
            }
        };

        return (
          <div className="flex h-screen w-screen text-textMain overflow-hidden font-sans selection:bg-primary/30">
            {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}
            
            {activeModal && (
              <Modal 
                isOpen={true} 
                onClose={() => setActiveModal(null)} 
                title={activeModal.title} 
                hideFooter={activeModal.hideFooter}
                children={activeModal.body}
              />
            )}

            <div className="fixed inset-0 pointer-events-none z-0">
                <div className="absolute top-[-10%] right-[-5%] w-[30%] h-[30%] bg-primary rounded-full blur-[150px] opacity-10"></div>
                <div className="absolute bottom-[-10%] left-[-5%] w-[30%] h-[30%] bg-blue-600 rounded-full blur-[150px] opacity-10"></div>
            </div>

            <LeftSidebar 
              currentRole={currentRole} 
              activeView={activeView}
              onChangeRole={handleGoHome} 
              onSettingsClick={handleSettings} 
              onNavigate={handleNavigate}
            />

            <main className="flex-1 flex flex-col min-w-0 relative z-10">
              <header className="h-[8vh] min-h-[60px] flex items-center justify-between px-[1.5vw] border-b border-white/5 bg-background/30 backdrop-blur-sm sticky top-0 z-20 shrink-0">
                <div className="flex items-center gap-4 text-responsive-sm text-textMuted">
                  <button className="hover:text-white cursor-pointer transition-colors flex items-center gap-2" onClick={handleGoHome}>
                     <Icon name="fa-house" className="text-xs"/>
                     Home
                  </button>
                  <Icon name="fa-chevron-right" className="text-[10px] opacity-50" />
                  <span className="text-white font-bold tracking-wide">{getPageTitle(activeView)}</span>
                </div>
                <div className="flex items-center gap-6">
                  <button onClick={handleNewTask} className="px-5 py-2.5 bg-primary hover:bg-primaryHover text-black text-sm font-bold rounded-xl transition-all shadow-[0_0_20px_rgba(249,115,22,0.2)] flex items-center gap-2 hover:translate-y-[-1px]">
                    <Icon name="fa-plus" />
                    <span>New Task</span>
                  </button>
                </div>
              </header>

              <div className="flex-1 overflow-y-auto p-[1.5vw] relative scroll-smooth custom-scrollbar">
                 <div className="h-full flex flex-col">
                    {renderDashboard()}
                 </div>
              </div>
            </main>

            <RightSidebar 
              currentRole={currentRole} 
              messages={currentRoleData?.messages || []} 
              todos={currentRoleData?.todos || []}
              onToggleTodo={(id) => handleToggleTodo(currentRole, id)}
            />
            
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // RENDER
      // ----------------------------------------------------------------------
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
